@* DmChat.razor - DM-to-LLM chat interface using Flowbite Chat components *@
@* Non-streaming implementation aligned with Flowbite Blazor AI Chat patterns *@

<div class="flex flex-col h-full min-h-0">
    <Conversation>
        <ConversationContent AutoScrollBehavior="ConversationAutoScrollBehavior.StickToBottom" Class="px-2 py-4">
            @if (!_messages.Any())
            {
                <div class="flex flex-col items-center justify-center h-48 text-center">
                    <BookOpenIcon Class="w-12 h-12 text-purple-500 dark:text-purple-400 mb-3" />
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">Ready to Begin</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 max-w-sm">
                        Describe a player action, ask for narrative guidance, or request a rules clarification.
                    </p>
                </div>
            }
            else
            {
                @foreach (var message in _messages)
                {
                    <ChatMessage @key="message.Id"
                                 From="@message.Role"
                                 AvatarInitials="@(message.Role == ChatMessageRole.User ? "DM" : "R")">
                        <ChatMessageContent Variant="@(message.Role == ChatMessageRole.User ? ChatMessageVariant.Contained : ChatMessageVariant.Flat)">
                            @if (!string.IsNullOrEmpty(message.Reasoning))
                            {
                                <Reasoning DefaultOpen="false">
                                    <ReasoningTrigger />
                                    <ReasoningContent Text="@message.Reasoning" />
                                </Reasoning>
                            }
                            
                            <ChatResponse Text="@message.Content" Role="@message.Role">
                                @if (message.Attachments?.Count > 0)
                                {
                                    <ul class="mt-3 flex flex-wrap gap-3">
                                        @foreach (var attachment in message.Attachments)
                                        {
                                            var previewUrl = GetAttachmentPreviewSource(attachment);
                                            <li class="flex min-w-[12rem] flex-1 items-center gap-3 rounded-2xl border border-gray-200/70 bg-white/80 p-3 text-xs text-gray-600 dark:border-white/10 dark:bg-slate-900/60 dark:text-gray-300">
                                                @if (previewUrl is not null)
                                                {
                                                    <img src="@previewUrl"
                                                         alt="@attachment.FileName"
                                                         class="h-14 w-14 flex-shrink-0 rounded-xl object-cover ring-1 ring-black/5 dark:ring-white/10"
                                                         draggable="false" />
                                                }
                                                else
                                                {
                                                    <div class="flex h-14 w-14 flex-shrink-0 items-center justify-center rounded-xl bg-gray-100 text-gray-500 dark:bg-slate-800 dark:text-gray-300">
                                                        <PaperClipIcon class="h-5 w-5" aria-hidden="true" />
                                                    </div>
                                                }
                                                <div class="min-w-0 text-left">
                                                    <p class="truncate text-sm font-medium text-gray-900 dark:text-white">@attachment.FileName</p>
                                                    <p class="text-[11px] uppercase tracking-wide text-gray-500 dark:text-gray-400">@attachment.ContentType</p>
                                                    <p class="text-[11px] text-gray-500 dark:text-gray-400">@FormatFileSize(attachment.Size)</p>
                                                    @if (attachment.IsPlainText && !string.IsNullOrWhiteSpace(attachment.TextPreview))
                                                    {
                                                        <p class="mt-1 whitespace-normal break-words text-xs italic text-gray-500 dark:text-gray-400">@attachment.TextPreview</p>
                                                    }
                                                </div>
                                            </li>
                                        }
                                    </ul>
                                }
                            </ChatResponse>

                        </ChatMessageContent>
                        
                        @if (message.Role == ChatMessageRole.Assistant)
                        {
                            <ChatActions Class="@(message.Role == ChatMessageRole.Assistant ? "justify-start -ml-3" : "justify-end ml-3")">
                                <ChatAction Tooltip="Copy" OnClick="@(() => CopyMessageAsync(message.Content))">
                                    <FileCopyAltIcon Class="h-4 w-4" aria-hidden="true" />
                                </ChatAction>
                                @if (message.TotalTokens.HasValue)
                                {
                                    <span class="text-xs text-gray-400 dark:text-gray-500 ml-2">
                                        @message.TotalTokens.Value.ToString("N0") tokens
                                    </span>
                                }
                            </ChatActions>
                        }
                    </ChatMessage>
                }
            }

            @if (_isBusy)
            {
                <div class="flex items-center gap-2 px-4 pb-4 text-sm text-gray-500 dark:text-gray-400">
                    <Loader />
                    <span>@_busyLabel</span>
                </div>
            }
        </ConversationContent>

        <ConversationScrollButton />
    </Conversation>

    <PromptInput OnSubmit="HandleSubmitAsync"
                 Text="@(_inputText ?? string.Empty)"
                 TextChanged="HandleTextChanged"
                 OnAttachmentsChanged="HandleAttachmentsChangedAsync">
        <PromptInputHeader>
            <PromptInputAttachments />
            @if (!string.IsNullOrEmpty(_attachmentValidationMessage))
            {
                <div class="px-3 py-2 text-sm text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-t-lg">
                    @_attachmentValidationMessage
                </div>
            }
        </PromptInputHeader>
        <PromptInputBody>
            <PromptInputActionMenu />
            <PromptInputTextarea Placeholder="Describe the action or ask Riddle for advice..." />
        </PromptInputBody>
        <PromptInputFooter Class="flex items-center justify-between">
            <span class="text-xs text-gray-400 dark:text-gray-500">
                Press Enter to send â€¢ Drag & drop files to attach
            </span>
            <PromptInputSubmit Status="@_submissionStatus"
                               Disabled="@(_hasUnsupportedAttachments || string.IsNullOrWhiteSpace(_inputText) && !_hasAttachments || _isBusy)"
                               Label=""
                               SubmittingLabel=""
                               StreamingLabel=""
                               ErrorLabel="" />
        </PromptInputFooter>
    </PromptInput>
</div>

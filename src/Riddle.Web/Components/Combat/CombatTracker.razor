@using Microsoft.AspNetCore.SignalR.Client
@using Riddle.Web.Hubs
@using Riddle.Web.Services
@using Flowbite.Components
@implements IAsyncDisposable

@* Display-only combat tracker - combat is controlled by LLM via tools *@
<Card Class="h-full">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
            <span class="text-xl">‚öîÔ∏è</span>
            Combat Tracker
        </h3>
        @if (Combat?.IsActive == true)
        {
            <Badge Color="BadgeColor.Pink">Round @Combat.RoundNumber</Badge>
        }
    </div>
    
    @if (Combat?.IsActive != true)
    {
        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            <div class="text-4xl mb-3">üõ°Ô∏è</div>
            <p>No active combat</p>
            <p class="text-xs mt-2 italic">The DM will initiate combat when enemies appear</p>
        </div>
    }
    else
    {
        <div class="space-y-2">
            @foreach (var (combatant, index) in Combat.TurnOrder.Select((c, i) => (c, i)))
            {
                <CombatantCard 
                    Combatant="combatant" 
                    Position="@(index + 1)"
                    IsCurrentTurn="@(index == Combat.CurrentTurnIndex)"
                    IsDm="IsDm" />
            }
        </div>
        
        @if (IsDm)
        {
            <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 text-center italic">
                    Combat is managed through chat commands
                </p>
            </div>
        }
    }
</Card>

@code {
    [Parameter] 
    public Guid CampaignId { get; set; }
    
    [Parameter] 
    public CombatStatePayload? Combat { get; set; }
    
    [Parameter] 
    public EventCallback<CombatStatePayload?> CombatChanged { get; set; }
    
    [Parameter] 
    public bool IsDm { get; set; }
    
    [Parameter]
    public List<Riddle.Web.Models.Character> PartyCharacters { get; set; } = [];
    
    [Inject] 
    private NavigationManager Navigation { get; set; } = null!;
    
    [Inject]
    private ILogger<CombatTracker> Logger { get; set; } = null!;
    
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await SetupSignalR();
    }

    private async Task SetupSignalR()
    {
        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
                .WithAutomaticReconnect([
                    TimeSpan.Zero, 
                    TimeSpan.FromSeconds(2), 
                    TimeSpan.FromSeconds(5),
                    TimeSpan.FromSeconds(10)
                ])
                .Build();

            _hubConnection.On<CombatStatePayload>(GameHubEvents.CombatStarted, async payload =>
            {
                Combat = payload;
                await CombatChanged.InvokeAsync(payload);
                await InvokeAsync(StateHasChanged);
            });

            _hubConnection.On<int, string>(GameHubEvents.TurnAdvanced, async (newIndex, currentId) =>
            {
                if (Combat != null)
                {
                    Combat = Combat with { CurrentTurnIndex = newIndex };
                    await CombatChanged.InvokeAsync(Combat);
                    await InvokeAsync(StateHasChanged);
                }
            });

            _hubConnection.On(GameHubEvents.CombatEnded, async () =>
            {
                Combat = null;
                await CombatChanged.InvokeAsync(null);
                await InvokeAsync(StateHasChanged);
            });

            await _hubConnection.StartAsync();
            
            // Join campaign group to receive combat updates
            if (CampaignId != Guid.Empty)
            {
                await _hubConnection.SendAsync("JoinCampaign", CampaignId, "", null, IsDm);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to setup SignalR connection for CombatTracker");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            try
            {
                if (CampaignId != Guid.Empty)
                {
                    await _hubConnection.SendAsync("LeaveCampaign", CampaignId);
                }
                await _hubConnection.DisposeAsync();
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Error disposing SignalR connection");
            }
        }
    }
}

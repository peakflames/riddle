@using Riddle.Web.Hubs

<div data-testid="combatant-@Combatant.Id" class="flex items-center justify-between p-3 rounded-lg border @(IsCurrentTurn ? "border-primary-500 bg-primary-50 dark:bg-primary-900/20" : "border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800")">
    <div class="flex items-center gap-3">
        @* Turn indicator *@
        @if (IsCurrentTurn)
        {
            <div data-testid="current-turn-indicator" class="flex items-center justify-center w-8 h-8 rounded-full bg-primary-500 text-white text-sm font-bold">
                ‚ñ∂
            </div>
        }
        else
        {
            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300 text-sm font-semibold">
                @Position
            </div>
        }
        
        @* Combatant info *@
        <div class="flex flex-col">
            <div class="flex items-center gap-2">
                @* Type indicator *@
                @if (Combatant.Type == "PC")
                {
                    <span class="text-lg">üßô</span>
                }
                else if (Combatant.Type == "NPC")
                {
                    <span class="text-lg">üë§</span>
                }
                else
                {
                    <span class="text-lg">üëπ</span>
                }
                
                <span data-testid="combatant-name" class="font-medium text-gray-900 dark:text-white @(ShouldShowStrikethrough() ? "line-through opacity-50" : "")">
                    @Combatant.Name
                </span>
                
                @if (Combatant.IsSurprised)
                {
                    <span data-testid="surprised-badge" class="px-1.5 py-0.5 text-xs rounded bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300">
                        Surprised
                    </span>
                }
                
                @* Defeated badge - only for non-PCs (monsters/NPCs die at 0 HP, PCs make death saves) *@
                @if (Combatant.IsDefeated && Combatant.Type != "PC")
                {
                    <span data-testid="defeated-badge" class="px-1.5 py-0.5 text-xs rounded bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                        ‚ò†Ô∏è Defeated
                    </span>
                }
                
                @* PC at 0 HP but not yet dead/stable - show Unconscious badge *@
                @if (Combatant.Type == "PC" && Combatant.CurrentHp <= 0 && !IsPcDead && !IsPcStable)
                {
                    <span data-testid="unconscious-badge" class="px-1.5 py-0.5 text-xs rounded bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300">
                        üòµ Unconscious
                    </span>
                }
                
                @* Death save status for PCs at 0 HP *@
                @if (Combatant.Type == "PC" && IsPcDead)
                {
                    <span data-testid="dead-badge" class="px-1.5 py-0.5 text-xs rounded bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 animate-pulse">
                        üíÄ Dead
                    </span>
                }
                else if (Combatant.Type == "PC" && IsPcStable)
                {
                    <span data-testid="stable-badge" class="px-1.5 py-0.5 text-xs rounded bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">
                        ‚úì Stable
                    </span>
                }
            </div>
            
            <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400">
                <span data-testid="initiative">Init: @Combatant.Initiative</span>
                
                @* Death save circles for PCs at 0 HP (or with any saves recorded) *@
                @if (Combatant.Type == "PC" && (Combatant.CurrentHp <= 0 || PcDeathSaveSuccesses > 0 || PcDeathSaveFailures > 0))
                {
                    <div data-testid="death-saves" class="flex items-center gap-2 ml-2">
                        <div class="flex items-center gap-0.5">
                            <span class="text-xs text-gray-400">S:</span>
                            @for (int i = 0; i < 3; i++)
                            {
                                <span class="w-2.5 h-2.5 rounded-full border @(i < PcDeathSaveSuccesses ? "bg-green-500 border-green-500" : "border-gray-500")"></span>
                            }
                        </div>
                        <div class="flex items-center gap-0.5">
                            <span class="text-xs text-gray-400">F:</span>
                            @for (int i = 0; i < 3; i++)
                            {
                                <span class="w-2.5 h-2.5 rounded-full border @(i < PcDeathSaveFailures ? "bg-red-500 border-red-500" : "border-gray-500")"></span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
    
    @* HP display - Hidden for enemies when viewed by players *@
    <div class="flex flex-col items-end">
        @if (ShouldShowExactHp())
        {
            <div class="flex items-center gap-1 text-sm font-medium">
                <span data-testid="hp-current" class="@GetHpColorClass()">@Combatant.CurrentHp</span>
                <span class="text-gray-400">/</span>
                <span data-testid="hp-max" class="text-gray-600 dark:text-gray-400">@Combatant.MaxHp</span>
            </div>
            <div class="w-24 h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                <div class="h-full @GetHpBarColorClass() transition-all duration-300"
                     style="width: @(Math.Max(0, Math.Min(100, (Combatant.CurrentHp * 100) / Math.Max(1, Combatant.MaxHp))))%">
                </div>
            </div>
        }
        else
        {
            @* Players see descriptive health status for enemies instead of exact numbers *@
            <div class="flex items-center gap-1 text-sm font-medium">
                <span data-testid="hp-status" class="@GetHpColorClass()">@GetHealthDescription()</span>
            </div>
            <div class="w-24 h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden opacity-50">
                @* Show approximate health bar without revealing exact HP *@
                <div class="h-full @GetHpBarColorClass() transition-all duration-300"
                     style="width: @GetApproximateHealthWidth()%">
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public CombatantInfo Combatant { get; set; } = null!;
    
    [Parameter]
    public int Position { get; set; }
    
    [Parameter]
    public bool IsCurrentTurn { get; set; }
    
    [Parameter]
    public bool IsDm { get; set; }
    
    /// <summary>
    /// Death save successes for PC combatants (passed from Character model)
    /// </summary>
    [Parameter]
    public int PcDeathSaveSuccesses { get; set; }
    
    /// <summary>
    /// Death save failures for PC combatants (passed from Character model)
    /// </summary>
    [Parameter]
    public int PcDeathSaveFailures { get; set; }
    
    /// <summary>
    /// Whether the PC is stable (3 successes at 0 HP)
    /// </summary>
    [Parameter]
    public bool IsPcStable { get; set; }
    
    /// <summary>
    /// Whether the PC is dead (3 failures)
    /// </summary>
    [Parameter]
    public bool IsPcDead { get; set; }
    
    private string GetHpColorClass()
    {
        var percentage = (Combatant.CurrentHp * 100) / Math.Max(1, Combatant.MaxHp);
        return percentage switch
        {
            <= 0 => "text-gray-500",
            <= 25 => "text-red-600 dark:text-red-400",
            <= 50 => "text-orange-600 dark:text-orange-400",
            _ => "text-green-600 dark:text-green-400"
        };
    }
    
    private string GetHpBarColorClass()
    {
        var percentage = (Combatant.CurrentHp * 100) / Math.Max(1, Combatant.MaxHp);
        return percentage switch
        {
            <= 0 => "bg-gray-400",
            <= 25 => "bg-red-500",
            <= 50 => "bg-orange-500",
            _ => "bg-green-500"
        };
    }
    
    /// <summary>
    /// Determines if exact HP should be shown. DMs always see exact HP.
    /// Players see exact HP for PCs/NPCs but not for enemies.
    /// </summary>
    private bool ShouldShowExactHp()
    {
        // DM always sees exact HP for all combatants
        if (IsDm) return true;
        
        // Players see exact HP for PCs and NPCs (allies), but not enemies
        return Combatant.Type == "PC" || Combatant.Type == "NPC";
    }
    
    /// <summary>
    /// Returns a descriptive health status for enemies when viewed by players.
    /// Classic D&D style: Healthy, Injured, Bloodied, Near Death, Defeated
    /// </summary>
    private string GetHealthDescription()
    {
        if (Combatant.IsDefeated || Combatant.CurrentHp <= 0)
            return "Defeated";
            
        var percentage = (Combatant.CurrentHp * 100) / Math.Max(1, Combatant.MaxHp);
        return percentage switch
        {
            > 75 => "Healthy",
            > 50 => "Injured",
            > 25 => "Bloodied",
            > 0 => "Near Death",
            _ => "Defeated"
        };
    }
    
    /// <summary>
    /// Returns approximate health bar width in percentage buckets.
    /// Uses 4 buckets to avoid revealing exact HP values.
    /// </summary>
    private int GetApproximateHealthWidth()
    {
        if (Combatant.IsDefeated || Combatant.CurrentHp <= 0)
            return 0;
            
        var percentage = (Combatant.CurrentHp * 100) / Math.Max(1, Combatant.MaxHp);
        return percentage switch
        {
            > 75 => 100,
            > 50 => 75,
            > 25 => 50,
            > 0 => 25,
            _ => 0
        };
    }
    
    /// <summary>
    /// Determines if the combatant's name should be struck through.
    /// PCs only get strikethrough when actually dead (3 failures).
    /// Non-PCs get strikethrough when defeated (0 HP).
    /// </summary>
    private bool ShouldShowStrikethrough()
    {
        if (Combatant.Type == "PC")
        {
            // PCs only struck through when actually dead
            return IsPcDead;
        }
        
        // Non-PCs struck through when defeated
        return Combatant.IsDefeated;
    }
}

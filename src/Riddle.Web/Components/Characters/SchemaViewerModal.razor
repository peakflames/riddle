@inject IWebHostEnvironment WebHostEnvironment

<Modal Show="@Show" ShowChanged="@ShowChanged" Size="ModalSize.FourExtraLarge">
    <ModalHeader>
        <h3>Character JSON Schema</h3>
    </ModalHeader>
    <ModalBody>
        @if (_isLoading)
        {
            <div class="flex justify-center py-8">
                <Spinner Size="SpinnerSize.Lg" />
            </div>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <Alert Color="AlertColor.Failure" Text="@_errorMessage" />
        }
        else
        {
            <div class="prose prose-sm dark:prose-invert max-w-none max-h-[70vh] overflow-y-auto">
                @((MarkupString)_renderedHtml)
            </div>
        }
    </ModalBody>
    <ModalFooter>
        <div class="flex justify-end w-full">
            <Button Color="ButtonColor.Gray" OnClick="@(() => ShowChanged.InvokeAsync(false))">Close</Button>
        </div>
    </ModalFooter>
</Modal>

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public EventCallback<bool> ShowChanged { get; set; }
    
    private string _renderedHtml = "";
    private string? _errorMessage;
    private bool _isLoading;
    private bool _hasLoaded;
    private bool _wasShown;
    
    protected override async Task OnParametersSetAsync()
    {
        // Load content when modal opens for the first time
        if (Show && !_wasShown && !_hasLoaded)
        {
            await LoadSchemaAsync();
        }
        _wasShown = Show;
    }
    
    private async Task LoadSchemaAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();
        
        try
        {
            // Read the markdown file directly from wwwroot (Blazor Server approach)
            var filePath = Path.Combine(WebHostEnvironment.WebRootPath, "docs", "character-schema.md");
            var markdown = await File.ReadAllTextAsync(filePath);
            _renderedHtml = RenderMarkdown(markdown);
            _hasLoaded = true;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load schema documentation: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    /// <summary>
    /// Simple markdown to HTML renderer for basic formatting.
    /// Handles headers, code blocks, tables, and lists.
    /// </summary>
    private static string RenderMarkdown(string markdown)
    {
        var lines = markdown.Split('\n');
        var html = new System.Text.StringBuilder();
        var inCodeBlock = false;
        var inTable = false;
        var inList = false;
        
        foreach (var rawLine in lines)
        {
            var line = rawLine.TrimEnd('\r');
            
            // Code blocks
            if (line.StartsWith("```"))
            {
                if (inCodeBlock)
                {
                    html.AppendLine("</code></pre>");
                    inCodeBlock = false;
                }
                else
                {
                    var lang = line.Length > 3 ? line[3..] : "";
                    html.AppendLine($"<pre class=\"bg-gray-800 text-gray-100 p-4 rounded-lg overflow-x-auto\"><code class=\"language-{lang}\">");
                    inCodeBlock = true;
                }
                continue;
            }
            
            if (inCodeBlock)
            {
                html.AppendLine(System.Web.HttpUtility.HtmlEncode(line));
                continue;
            }
            
            // Tables
            if (line.StartsWith("|"))
            {
                if (!inTable)
                {
                    html.AppendLine("<table class=\"min-w-full text-sm\">");
                    inTable = true;
                }
                
                // Skip separator rows
                if (line.Contains("---"))
                {
                    continue;
                }
                
                var cells = line.Split('|', StringSplitOptions.RemoveEmptyEntries);
                var isHeader = !html.ToString().Contains("<tbody>");
                
                if (isHeader)
                {
                    html.AppendLine("<thead class=\"bg-gray-100 dark:bg-gray-700\"><tr>");
                    foreach (var cell in cells)
                    {
                        html.AppendLine($"<th class=\"px-3 py-2 text-left\">{FormatInline(cell.Trim())}</th>");
                    }
                    html.AppendLine("</tr></thead><tbody>");
                }
                else
                {
                    html.AppendLine("<tr class=\"border-b dark:border-gray-600\">");
                    foreach (var cell in cells)
                    {
                        html.AppendLine($"<td class=\"px-3 py-2\">{FormatInline(cell.Trim())}</td>");
                    }
                    html.AppendLine("</tr>");
                }
                continue;
            }
            else if (inTable)
            {
                html.AppendLine("</tbody></table>");
                inTable = false;
            }
            
            // Lists
            if (line.StartsWith("- "))
            {
                if (!inList)
                {
                    html.AppendLine("<ul class=\"list-disc pl-5 space-y-1\">");
                    inList = true;
                }
                html.AppendLine($"<li>{FormatInline(line[2..])}</li>");
                continue;
            }
            else if (inList && !string.IsNullOrWhiteSpace(line))
            {
                html.AppendLine("</ul>");
                inList = false;
            }
            
            // Headers
            if (line.StartsWith("### "))
            {
                html.AppendLine($"<h3 class=\"text-lg font-semibold mt-6 mb-2\">{FormatInline(line[4..])}</h3>");
                continue;
            }
            if (line.StartsWith("## "))
            {
                html.AppendLine($"<h2 class=\"text-xl font-bold mt-8 mb-3\">{FormatInline(line[3..])}</h2>");
                continue;
            }
            if (line.StartsWith("# "))
            {
                html.AppendLine($"<h1 class=\"text-2xl font-bold mb-4\">{FormatInline(line[2..])}</h1>");
                continue;
            }
            
            // Horizontal rule
            if (line.StartsWith("---"))
            {
                html.AppendLine("<hr class=\"my-6 border-gray-300 dark:border-gray-600\" />");
                continue;
            }
            
            // Paragraphs
            if (!string.IsNullOrWhiteSpace(line))
            {
                html.AppendLine($"<p class=\"mb-2\">{FormatInline(line)}</p>");
            }
        }
        
        // Close any open elements
        if (inList) html.AppendLine("</ul>");
        if (inTable) html.AppendLine("</tbody></table>");
        if (inCodeBlock) html.AppendLine("</code></pre>");
        
        return html.ToString();
    }
    
    /// <summary>
    /// Format inline markdown elements (bold, code, etc.)
    /// </summary>
    private static string FormatInline(string text)
    {
        // Escape HTML first
        text = System.Web.HttpUtility.HtmlEncode(text);
        
        // Inline code
        text = System.Text.RegularExpressions.Regex.Replace(
            text, 
            @"`([^`]+)`", 
            "<code class=\"bg-gray-200 dark:bg-gray-600 px-1 rounded text-sm\">$1</code>");
        
        // Bold
        text = System.Text.RegularExpressions.Regex.Replace(
            text, 
            @"\*\*([^*]+)\*\*", 
            "<strong>$1</strong>");
        
        return text;
    }
}

@using Riddle.Web.Models
@using System.ComponentModel.DataAnnotations

<Modal Show="@Show" ShowChanged="@ShowChanged" Size="ModalSize.FourExtraLarge">
    <ModalHeader>
        <h3>@(IsEditing ? "Edit Character" : "Add Character")</h3>
    </ModalHeader>
    <ModalBody>
        <EditForm Model="@_model" OnValidSubmit="@HandleSubmit" Context="editContext">
            <DataAnnotationsValidator />
            
            <Tabs Variant="TabVariant.Underline">
                <TabListContent>
                    <Tab Index="0">Quick Entry</Tab>
                    <Tab Index="1">Full Entry</Tab>
                </TabListContent>
                <TabPanelsContent>
                    <!-- Quick Entry Tab -->
                    <TabPanel Index="0">
                        <div class="space-y-4 py-4">
                            <!-- Name & Type Row -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <Label For="name" Value="Character Name" Required="true" />
                                    <TextInput TValue="string" Id="name" @bind-Value="_model.Name" 
                                               Placeholder="e.g., Thorin Ironforge" />
                                    <ValidationMessage For="@(() => _model.Name)" />
                                </div>
                                <div>
                                    <Label For="type" Value="Type" />
                                    <Select TValue="string" Id="type" @bind-Value="_model.Type">
                                        <option value="PC">Player Character</option>
                                        <option value="NPC">NPC</option>
                                    </Select>
                                </div>
                            </div>
                            
                            <!-- Class & Race Row -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <Label For="class" Value="Class" />
                                    <Select TValue="string" Id="class" @bind-Value="_model.Class">
                                        <option value="">Select Class</option>
                                        @foreach (var cls in _classes)
                                        {
                                            <option value="@cls">@cls</option>
                                        }
                                    </Select>
                                </div>
                                <div>
                                    <Label For="race" Value="Race" />
                                    <Select TValue="string" Id="race" @bind-Value="_model.Race">
                                        <option value="">Select Race</option>
                                        @foreach (var race in _races)
                                        {
                                            <option value="@race">@race</option>
                                        }
                                    </Select>
                                </div>
                            </div>
                            
                            <!-- Level, HP, AC Row -->
                            <div class="grid grid-cols-4 gap-4">
                                <div>
                                    <Label For="level" Value="Level" />
                                    <TextInput TValue="int" Id="level" @bind-Value="_model.Level" Type="number" />
                                </div>
                                <div>
                                    <Label For="maxHp" Value="Max HP" Required="true" />
                                    <TextInput TValue="int" Id="maxHp" @bind-Value="_model.MaxHp" Type="number" />
                                    <ValidationMessage For="@(() => _model.MaxHp)" />
                                </div>
                                <div>
                                    <Label For="currentHp" Value="Current HP" />
                                    <TextInput TValue="int" Id="currentHp" @bind-Value="_model.CurrentHp" Type="number" />
                                </div>
                                <div>
                                    <Label For="ac" Value="Armor Class" Required="true" />
                                    <TextInput TValue="int" Id="ac" @bind-Value="_model.ArmorClass" Type="number" />
                                    <ValidationMessage For="@(() => _model.ArmorClass)" />
                                </div>
                            </div>
                        </div>
                    </TabPanel>
                    
                    <!-- Full Entry Tab -->
                    <TabPanel Index="1">
                        <div class="space-y-6 py-4 max-h-96 overflow-y-auto">
                            <!-- Core Info Section -->
                            <div>
                                <h4 class="mb-3 font-semibold text-gray-900 dark:text-white">Core Information</h4>
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <Label For="name2" Value="Character Name" Required="true" />
                                        <TextInput TValue="string" Id="name2" @bind-Value="_model.Name" />
                                    </div>
                                    <div>
                                        <Label For="background" Value="Background" />
                                        <Select TValue="string" Id="background" @bind-Value="_model.Background">
                                            <option value="">Select Background</option>
                                            @foreach (var bg in _backgrounds)
                                            {
                                                <option value="@bg">@bg</option>
                                            }
                                        </Select>
                                    </div>
                                    <div>
                                        <Label For="alignment" Value="Alignment" />
                                        <Select TValue="string" Id="alignment" @bind-Value="_model.Alignment">
                                            <option value="">Select Alignment</option>
                                            @foreach (var align in _alignments)
                                            {
                                                <option value="@align">@align</option>
                                            }
                                        </Select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ability Scores Section -->
                            <div>
                                <h4 class="mb-3 font-semibold text-gray-900 dark:text-white">Ability Scores</h4>
                                <div class="grid grid-cols-6 gap-3">
                                    <div class="text-center">
                                        <Label For="str" Value="STR" />
                                        <TextInput TValue="int" Id="str" @bind-Value="_model.Strength" Type="number" Class="text-center" />
                                        <span class="text-xs text-gray-500">(@FormatModifier(_model.Strength))</span>
                                    </div>
                                    <div class="text-center">
                                        <Label For="dex" Value="DEX" />
                                        <TextInput TValue="int" Id="dex" @bind-Value="_model.Dexterity" Type="number" Class="text-center" />
                                        <span class="text-xs text-gray-500">(@FormatModifier(_model.Dexterity))</span>
                                    </div>
                                    <div class="text-center">
                                        <Label For="con" Value="CON" />
                                        <TextInput TValue="int" Id="con" @bind-Value="_model.Constitution" Type="number" Class="text-center" />
                                        <span class="text-xs text-gray-500">(@FormatModifier(_model.Constitution))</span>
                                    </div>
                                    <div class="text-center">
                                        <Label For="int" Value="INT" />
                                        <TextInput TValue="int" Id="int" @bind-Value="_model.Intelligence" Type="number" Class="text-center" />
                                        <span class="text-xs text-gray-500">(@FormatModifier(_model.Intelligence))</span>
                                    </div>
                                    <div class="text-center">
                                        <Label For="wis" Value="WIS" />
                                        <TextInput TValue="int" Id="wis" @bind-Value="_model.Wisdom" Type="number" Class="text-center" />
                                        <span class="text-xs text-gray-500">(@FormatModifier(_model.Wisdom))</span>
                                    </div>
                                    <div class="text-center">
                                        <Label For="cha" Value="CHA" />
                                        <TextInput TValue="int" Id="cha" @bind-Value="_model.Charisma" Type="number" Class="text-center" />
                                        <span class="text-xs text-gray-500">(@FormatModifier(_model.Charisma))</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Combat Stats Section -->
                            <div>
                                <h4 class="mb-3 font-semibold text-gray-900 dark:text-white">Combat Stats</h4>
                                <div class="grid grid-cols-5 gap-4">
                                    <div>
                                        <Label For="initiative" Value="Initiative" />
                                        <TextInput TValue="int" Id="initiative" @bind-Value="_model.Initiative" Type="number" />
                                    </div>
                                    <div>
                                        <Label For="speed" Value="Speed" />
                                        <TextInput TValue="string" Id="speed" @bind-Value="_model.Speed" Placeholder="30 ft" />
                                    </div>
                                    <div>
                                        <Label For="passivePerception" Value="Passive Perception" />
                                        <TextInput TValue="int" Id="passivePerception" @bind-Value="_model.PassivePerception" Type="number" />
                                    </div>
                                    <div class="col-span-2">
                                        <Label For="languages" Value="Languages (comma-separated)" />
                                        <TextInput TValue="string" Id="languages" @bind-Value="_languagesText" Placeholder="Common, Elvish" />
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Spellcasting Section -->
                            <div>
                                <div class="flex items-center gap-2 mb-3">
                                    <ToggleSwitch @bind-Checked="_model.IsSpellcaster" Label="Spellcaster" />
                                </div>
                                @if (_model.IsSpellcaster)
                                {
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <Label For="spellAbility" Value="Spellcasting Ability" />
                                            <Select TValue="string" Id="spellAbility" @bind-Value="_model.SpellcastingAbility">
                                                <option value="">Select Ability</option>
                                                <option value="Intelligence">Intelligence</option>
                                                <option value="Wisdom">Wisdom</option>
                                                <option value="Charisma">Charisma</option>
                                            </Select>
                                        </div>
                                        <div>
                                            <Label For="spellDc" Value="Spell Save DC" />
                                            <TextInput TValue="int?" Id="spellDc" @bind-Value="_model.SpellSaveDC" Type="number" />
                                        </div>
                                        <div>
                                            <Label For="spellAttack" Value="Spell Attack Bonus" />
                                            <TextInput TValue="int?" Id="spellAttack" @bind-Value="_model.SpellAttackBonus" Type="number" />
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            <!-- Notes Section -->
                            <div>
                                <h4 class="mb-3 font-semibold text-gray-900 dark:text-white">Notes</h4>
                                <Textarea Id="notes" @bind-Value="_model.StatusNotes" Rows="3" 
                                          Placeholder="Additional notes about this character..." />
                            </div>
                        </div>
                    </TabPanel>
                </TabPanelsContent>
            </Tabs>
            
            <!-- Hidden submit for form -->
            <button type="submit" class="hidden" />
        </EditForm>
    </ModalBody>
    <ModalFooter>
        <div class="flex justify-end w-full gap-2">
            <Button Color="ButtonColor.Gray" OnClick="@HandleCancel">Cancel</Button>
            <Button Color="ButtonColor.Primary" OnClick="@HandleSubmitClick">
                @(IsEditing ? "Save Changes" : "Add Character")
            </Button>
        </div>
    </ModalFooter>
</Modal>

@code {
    [Parameter]
    public bool Show { get; set; }
    
    [Parameter]
    public EventCallback<bool> ShowChanged { get; set; }
    
    [Parameter]
    public Character? EditingCharacter { get; set; }
    
    [Parameter]
    public EventCallback<Character> OnSave { get; set; }
    
    private bool IsEditing => EditingCharacter != null;
    
    private CharacterFormModel _model = new();
    private string _languagesText = "Common";
    
    private static readonly string[] _classes = ["Barbarian", "Bard", "Cleric", "Druid", "Fighter", "Monk", "Paladin", "Ranger", "Rogue", "Sorcerer", "Warlock", "Wizard"];
    private static readonly string[] _races = ["Dragonborn", "Dwarf", "Elf", "Gnome", "Half-Elf", "Half-Orc", "Halfling", "Human", "Tiefling"];
    private static readonly string[] _backgrounds = ["Acolyte", "Charlatan", "Criminal", "Entertainer", "Folk Hero", "Guild Artisan", "Hermit", "Noble", "Outlander", "Sage", "Sailor", "Soldier", "Urchin"];
    private static readonly string[] _alignments = ["Lawful Good", "Neutral Good", "Chaotic Good", "Lawful Neutral", "True Neutral", "Chaotic Neutral", "Lawful Evil", "Neutral Evil", "Chaotic Evil"];
    
    protected override void OnParametersSet()
    {
        if (Show && EditingCharacter != null)
        {
            // Populate form from existing character
            _model = new CharacterFormModel
            {
                Name = EditingCharacter.Name,
                Type = EditingCharacter.Type,
                Race = EditingCharacter.Race,
                Class = EditingCharacter.Class,
                Level = EditingCharacter.Level,
                Background = EditingCharacter.Background,
                Alignment = EditingCharacter.Alignment,
                Strength = EditingCharacter.Strength,
                Dexterity = EditingCharacter.Dexterity,
                Constitution = EditingCharacter.Constitution,
                Intelligence = EditingCharacter.Intelligence,
                Wisdom = EditingCharacter.Wisdom,
                Charisma = EditingCharacter.Charisma,
                ArmorClass = EditingCharacter.ArmorClass,
                MaxHp = EditingCharacter.MaxHp,
                CurrentHp = EditingCharacter.CurrentHp,
                Initiative = EditingCharacter.Initiative,
                Speed = EditingCharacter.Speed,
                PassivePerception = EditingCharacter.PassivePerception,
                IsSpellcaster = EditingCharacter.IsSpellcaster,
                SpellcastingAbility = EditingCharacter.SpellcastingAbility,
                SpellSaveDC = EditingCharacter.SpellSaveDC,
                SpellAttackBonus = EditingCharacter.SpellAttackBonus,
                StatusNotes = EditingCharacter.StatusNotes
            };
            _languagesText = string.Join(", ", EditingCharacter.Languages);
        }
        else if (Show && EditingCharacter == null)
        {
            // Reset form for new character
            _model = new CharacterFormModel();
            _languagesText = "Common";
        }
    }
    
    private void HandleCancel()
    {
        ShowChanged.InvokeAsync(false);
    }
    
    private async Task HandleSubmitClick()
    {
        await HandleSubmit();
    }
    
    private async Task HandleSubmit()
    {
        var character = EditingCharacter ?? new Character();
        
        // Map form to character
        character.Name = _model.Name;
        character.Type = _model.Type;
        character.Race = _model.Race;
        character.Class = _model.Class;
        character.Level = _model.Level;
        character.Background = _model.Background;
        character.Alignment = _model.Alignment;
        character.Strength = _model.Strength;
        character.Dexterity = _model.Dexterity;
        character.Constitution = _model.Constitution;
        character.Intelligence = _model.Intelligence;
        character.Wisdom = _model.Wisdom;
        character.Charisma = _model.Charisma;
        character.ArmorClass = _model.ArmorClass;
        character.MaxHp = _model.MaxHp;
        character.CurrentHp = _model.CurrentHp > 0 ? _model.CurrentHp : _model.MaxHp;
        character.Initiative = _model.Initiative;
        character.Speed = _model.Speed;
        character.PassivePerception = _model.PassivePerception;
        character.IsSpellcaster = _model.IsSpellcaster;
        character.SpellcastingAbility = _model.SpellcastingAbility;
        character.SpellSaveDC = _model.SpellSaveDC;
        character.SpellAttackBonus = _model.SpellAttackBonus;
        character.StatusNotes = _model.StatusNotes;
        character.Languages = _languagesText.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList();
        
        await OnSave.InvokeAsync(character);
        await ShowChanged.InvokeAsync(false);
    }
    
    private static string FormatModifier(int score)
    {
        var mod = (score - 10) / 2;
        return mod >= 0 ? $"+{mod}" : mod.ToString();
    }
    
    private class CharacterFormModel
    {
        [Required(ErrorMessage = "Name is required")]
        public string Name { get; set; } = "";
        
        public string Type { get; set; } = "PC";
        public string? Race { get; set; }
        public string? Class { get; set; }
        public int Level { get; set; } = 1;
        public string? Background { get; set; }
        public string? Alignment { get; set; }
        public int Strength { get; set; } = 10;
        public int Dexterity { get; set; } = 10;
        public int Constitution { get; set; } = 10;
        public int Intelligence { get; set; } = 10;
        public int Wisdom { get; set; } = 10;
        public int Charisma { get; set; } = 10;
        
        [Range(1, 30, ErrorMessage = "AC must be between 1 and 30")]
        public int ArmorClass { get; set; } = 10;
        
        [Range(1, 500, ErrorMessage = "Max HP must be at least 1")]
        public int MaxHp { get; set; } = 10;
        
        public int CurrentHp { get; set; }
        public int Initiative { get; set; }
        public string Speed { get; set; } = "30 ft";
        public int PassivePerception { get; set; } = 10;
        public bool IsSpellcaster { get; set; }
        public string? SpellcastingAbility { get; set; }
        public int? SpellSaveDC { get; set; }
        public int? SpellAttackBonus { get; set; }
        public string? StatusNotes { get; set; }
    }
}

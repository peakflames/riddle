@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Riddle.Web.Services
@using Riddle.Web.Models
@inject ICampaignService CampaignService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Campaigns - Riddle</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="p-4 sm:p-6">
            <div class="mb-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <Heading Tag="HeadingTag.H1" Size="TextSize.XXXL">Campaigns</Heading>
                    <Paragraph CustomColor="text-gray-500 dark:text-gray-400">
                        Manage your D&D campaigns.
                    </Paragraph>
                </div>
                <div class="flex gap-2">
                    <Button Href="/campaigns/new" Color="ButtonColor.Primary">
                        <PlusIcon Class="w-4 h-4 mr-2" />
                        Add
                    </Button>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="flex items-center justify-center p-8">
                    <Spinner Size="SpinnerSize.Xl" />
                </div>
            }
            else if (!campaigns.Any())
            {
                <Alert Color="AlertColor.Info" TextEmphasis="No campaigns found." 
                       Text="Get started by creating a new campaign." />
            }
            else
            {
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    @foreach (var campaign in campaigns)
                    {
                        <Card Size="CardSize.ExtraLarge" class="!max-w-none bg-gray-800 border-gray-700">
                            <div class="p-4 flex flex-col h-full">
                                @* Header *@
                                <div class="mb-3">
                                    <h5 class="text-xl font-bold tracking-tight text-gray-900 dark:text-white">
                                        @campaign.Name
                                    </h5>
                                    <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mt-1">
                                        <span>üìç @GetLocationDisplay(campaign)</span>
                                        <span>‚Ä¢</span>
                                        <span>üïê @GetTimeAgo(campaign.LastActivityAt)</span>
                                    </div>
                                </div>
                                
                                @* Party Section *@
                                <div class="flex-1 mb-4">
                                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Party</p>
                                    @if (campaign.PartyState.Any())
                                    {
                                        <div class="space-y-1">
                                            @foreach (var character in campaign.PartyState)
                                            {
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="text-gray-900 dark:text-white">
                                                        @character.Name 
                                                        <span class="text-gray-500 dark:text-gray-400">(@character.Class)</span>
                                                    </span>
                                                    @if (!string.IsNullOrEmpty(character.PlayerId))
                                                    {
                                                        <Badge Color="BadgeColor.Success" class="text-xs">claimed</Badge>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-xs text-gray-400">unclaimed</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-sm text-gray-400 italic">No characters yet</p>
                                    }
                                </div>
                                
                                @* Action Buttons *@
                                <div class="flex items-center gap-2 pt-3 border-t border-gray-200 dark:border-gray-700">
                                    <Button Href="@($"/dm/{campaign.Id}")" Color="ButtonColor.Primary" Size="ButtonSize.Small" class="flex-1">
                                        Play
                                    </Button>
                                    <Button Color="ButtonColor.Light" Size="ButtonSize.Small" @onclick="@(() => ShowEditModal(campaign))">
                                        <PencilIcon Class="w-4 h-4" />
                                    </Button>
                                    <Button Color="ButtonColor.Light" Size="ButtonSize.Small" @onclick="@(() => ShowDeleteConfirmation(campaign))">
                                        <TrashBinIcon Class="w-4 h-4 text-red-500" />
                                    </Button>
                                </div>
                            </div>
                        </Card>
                    }
                </div>
            }
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
            <div class="max-w-md">
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
                    Welcome to Riddle
                </h1>
                <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">
                    Your AI-powered Dungeon Master assistant for D&D 5th Edition. 
                    Sign in to start your adventure.
                </p>
                <Button Href="/Account/Login" Color="ButtonColor.Primary" Size="ButtonSize.Large" Class="w-full sm:w-auto">
                    Sign in with Google
                </Button>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@* Edit Campaign Modal *@
<Modal @bind-Show="_showEditModal" Size="ModalSize.Large">
    <ModalHeader>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            Edit Campaign Settings
        </h3>
    </ModalHeader>
    <ModalBody>
        <Tabs Variant="TabVariant.Underline">
            <TabListContent>
                <Tab Index="0">General</Tab>
                <Tab Index="1">Preferences</Tab>
            </TabListContent>
            <TabPanelsContent>
                <TabPanel Index="0">
                    <div class="space-y-4 pt-4">
                        <div>
                            <Label For="campaignName" Value="Campaign Name" />
                            <TextInput Id="campaignName" @bind-Value="_editModel.Name" Placeholder="My Campaign" />
                        </div>
                        <div>
                            <Label For="campaignModule" Value="Campaign Module" />
                            <TextInput Id="campaignModule" Value="@_editModel.CampaignModule" Disabled="true" 
                                       class="bg-gray-100 dark:bg-gray-600 cursor-not-allowed" />
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Campaign module cannot be changed after creation.
                            </p>
                        </div>
                    </div>
                </TabPanel>
                <TabPanel Index="1">
                    <div class="space-y-4 pt-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <Label For="combatFocus" Value="Combat Focus" />
                                <Select Id="combatFocus" @bind-Value="_editModel.CombatFocus">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </Select>
                            </div>
                            <div>
                                <Label For="roleplayFocus" Value="Roleplay Focus" />
                                <Select Id="roleplayFocus" @bind-Value="_editModel.RoleplayFocus">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </Select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <Label For="pacing" Value="Pacing" />
                                <Select Id="pacing" @bind-Value="_editModel.Pacing">
                                    <option value="Fast">Fast</option>
                                    <option value="Methodical">Methodical</option>
                                </Select>
                            </div>
                            <div>
                                <Label For="tone" Value="Tone" />
                                <Select Id="tone" @bind-Value="_editModel.Tone">
                                    <option value="Adventurous">Adventurous</option>
                                    <option value="Dark">Dark</option>
                                    <option value="Comedic">Comedic</option>
                                </Select>
                            </div>
                        </div>
                        <div>
                            <Label For="avoidedTopics" Value="Avoided Topics" />
                            <TextInput Id="avoidedTopics" @bind-Value="_editModel.AvoidedTopics" 
                                       Placeholder="e.g., spiders, drowning (comma-separated)" />
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Topics the party wants to avoid. Separate multiple topics with commas.
                            </p>
                        </div>
                    </div>
                </TabPanel>
            </TabPanelsContent>
        </Tabs>
    </ModalBody>
    <ModalFooter>
        <div class="flex justify-end gap-3">
            <Button Color="ButtonColor.Light" @onclick="CancelEdit">
                Cancel
            </Button>
            <Button Color="ButtonColor.Primary" @onclick="SaveChanges" Disabled="_isSaving">
                @if (_isSaving)
                {
                    <Spinner Size="SpinnerSize.Sm" class="mr-2" />
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save Changes</span>
                }
            </Button>
        </div>
    </ModalFooter>
</Modal>

@* Delete Confirmation Modal *@
<Modal @bind-Show="_showDeleteModal" Size="ModalSize.Small">
    <ModalHeader>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            Delete Campaign
        </h3>
    </ModalHeader>
    <ModalBody>
        <div class="text-center">
            <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900">
                <ExclamationCircleIcon Class="h-6 w-6 text-red-600 dark:text-red-400" />
            </div>
            <p class="mb-2 text-gray-500 dark:text-gray-400">
                Are you sure you want to delete
            </p>
            <p class="mb-4 font-semibold text-gray-900 dark:text-white">
                @_campaignToDelete?.Name
            </p>
            <p class="text-sm text-gray-500 dark:text-gray-400">
                This action cannot be undone. All campaign data, including characters and combat history, will be permanently deleted.
            </p>
        </div>
    </ModalBody>
    <ModalFooter>
        <div class="flex justify-center gap-4">
            <Button Color="ButtonColor.Light" @onclick="CancelDelete">
                Cancel
            </Button>
            <Button Color="ButtonColor.Red" @onclick="ConfirmDelete" Disabled="_isDeleting">
                @if (_isDeleting)
                {
                    <Spinner Size="SpinnerSize.Sm" class="mr-2" />
                    <span>Deleting...</span>
                }
                else
                {
                    <span>Yes, delete</span>
                }
            </Button>
        </div>
    </ModalFooter>
</Modal>

@code {
    private List<CampaignInstance> campaigns = new();
    private bool isLoading = true;
    private string? currentUserId;
    
    // Delete confirmation modal state
    private bool _showDeleteModal = false;
    private CampaignInstance? _campaignToDelete;
    private bool _isDeleting = false;
    
    // Edit modal state
    private bool _showEditModal = false;
    private CampaignInstance? _campaignToEdit;
    private CampaignEditModel _editModel = new();
    private bool _isSaving = false;
    
    // Edit model class to hold form values
    private class CampaignEditModel
    {
        public string Name { get; set; } = "";
        public string CampaignModule { get; set; } = "";
        public string CombatFocus { get; set; } = "Medium";
        public string RoleplayFocus { get; set; } = "Medium";
        public string Pacing { get; set; } = "Methodical";
        public string Tone { get; set; } = "Adventurous";
        public string AvoidedTopics { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            if (!string.IsNullOrEmpty(currentUserId))
            {
                await LoadCampaignsAsync();
            }
        }
        
        isLoading = false;
    }

    private async Task LoadCampaignsAsync()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        campaigns = await CampaignService.GetCampaignsForUserAsync(currentUserId);
    }

    private string GetLocationDisplay(CampaignInstance campaign)
    {
        // Convert location ID to human-readable format
        return campaign.CurrentLocationId.Replace("_", " ").ToUpperInvariant() switch
        {
            var x when x.Contains("GOBLIN") => "Goblin Ambush",
            var x when x.Contains("PHANDALIN") => "Phandalin",
            var x when x.Contains("CRAGMAW") => "Cragmaw Hideout",
            var x when x.Contains("REDBRAND") => "Redbrand Hideout",
            _ => campaign.CurrentLocationId.Replace("_", " ")
        };
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        return timeSpan switch
        {
            { TotalMinutes: < 1 } => "Just now",
            { TotalMinutes: < 60 } => $"{(int)timeSpan.TotalMinutes}m ago",
            { TotalHours: < 24 } => $"{(int)timeSpan.TotalHours}h ago",
            { TotalDays: < 7 } => $"{(int)timeSpan.TotalDays}d ago",
            { TotalDays: < 30 } => $"{(int)(timeSpan.TotalDays / 7)}w ago",
            _ => $"{(int)(timeSpan.TotalDays / 30)}mo ago"
        };
    }
    
    private void ShowDeleteConfirmation(CampaignInstance campaign)
    {
        _campaignToDelete = campaign;
        _showDeleteModal = true;
    }
    
    private void CancelDelete()
    {
        _showDeleteModal = false;
        _campaignToDelete = null;
    }
    
    private async Task ConfirmDelete()
    {
        if (_campaignToDelete == null) return;
        
        _isDeleting = true;
        try
        {
            await CampaignService.DeleteCampaignAsync(_campaignToDelete.Id);
            _showDeleteModal = false;
            _campaignToDelete = null;
            
            // Refresh campaign list
            await LoadCampaignsAsync();
        }
        finally
        {
            _isDeleting = false;
        }
    }
    
    private void ShowEditModal(CampaignInstance campaign)
    {
        _campaignToEdit = campaign;
        
        // Clone campaign data into edit model
        _editModel = new CampaignEditModel
        {
            Name = campaign.Name,
            CampaignModule = campaign.CampaignModule,
            CombatFocus = campaign.Preferences.CombatFocus,
            RoleplayFocus = campaign.Preferences.RoleplayFocus,
            Pacing = campaign.Preferences.Pacing,
            Tone = campaign.Preferences.Tone,
            AvoidedTopics = string.Join(", ", campaign.Preferences.AvoidedTopics)
        };
        
        _showEditModal = true;
    }
    
    private void CancelEdit()
    {
        _showEditModal = false;
        _campaignToEdit = null;
        _editModel = new();
    }
    
    private async Task SaveChanges()
    {
        if (_campaignToEdit == null) return;
        
        _isSaving = true;
        try
        {
            // Update campaign name
            _campaignToEdit.Name = _editModel.Name;
            
            // Update preferences
            var prefs = _campaignToEdit.Preferences;
            prefs.CombatFocus = _editModel.CombatFocus;
            prefs.RoleplayFocus = _editModel.RoleplayFocus;
            prefs.Pacing = _editModel.Pacing;
            prefs.Tone = _editModel.Tone;
            prefs.AvoidedTopics = _editModel.AvoidedTopics
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();
            _campaignToEdit.Preferences = prefs;
            
            // Update last activity
            _campaignToEdit.LastActivityAt = DateTime.UtcNow;
            
            // Save to database
            await CampaignService.UpdateCampaignAsync(_campaignToEdit);
            
            _showEditModal = false;
            _campaignToEdit = null;
            _editModel = new();
            
            // Refresh campaign list
            await LoadCampaignsAsync();
        }
        finally
        {
            _isSaving = false;
        }
    }
}

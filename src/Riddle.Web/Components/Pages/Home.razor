@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Riddle.Web.Services
@using Riddle.Web.Models
@inject ICampaignService CampaignService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>Dashboard - Riddle</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="mt-px space-y-4">
            <section class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
                <Card Size="CardSize.ExtraLarge" class="max-w-none">
                    <div class="flex items-center justify-between p-4">
                        <div>
                            <h5 class="text-2xl font-bold leading-none text-gray-900 dark:text-white">Active Campaigns</h5>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Your ongoing D&D campaigns</p>
                        </div>
                        <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-primary-100 dark:bg-primary-900">
                            <LayersIcon Class="w-6 h-6 text-primary-600 dark:text-primary-400" />
                        </div>
                    </div>
                    <div class="p-4 pt-0">
                        <p class="text-3xl font-bold text-gray-900 dark:text-white">@campaignCount</p>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            campaigns
                        </p>
                    </div>
                </Card>

                <Card Size="CardSize.ExtraLarge" class="max-w-none">
                    <div class="flex items-center justify-between p-4">
                        <div>
                            <h5 class="text-2xl font-bold leading-none text-gray-900 dark:text-white">Characters</h5>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Party members across all campaigns</p>
                        </div>
                        <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-purple-100 dark:bg-purple-900">
                            <UsersIcon Class="w-6 h-6 text-purple-600 dark:text-purple-400" />
                        </div>
                    </div>
                    <div class="p-4 pt-0">
                        <p class="text-3xl font-bold text-gray-900 dark:text-white">@characterCount</p>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            total characters
                        </p>
                    </div>
                </Card>

                <Card Size="CardSize.ExtraLarge" class="max-w-none">
                    <div class="flex items-center justify-between p-4">
                        <div>
                            <h5 class="text-2xl font-bold leading-none text-gray-900 dark:text-white">Last Activity</h5>
                            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Most recent campaign activity</p>
                        </div>
                        <div class="flex items-center justify-center w-12 h-12 rounded-lg bg-green-100 dark:bg-green-900">
                            <ClockIcon Class="w-6 h-6 text-green-600 dark:text-green-400" />
                        </div>
                    </div>
                    <div class="p-4 pt-0">
                        <p class="text-xl font-bold text-gray-900 dark:text-white">@lastActivityText</p>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            @lastCampaignName
                        </p>
                    </div>
                </Card>
            </section>

            <section>
                <Card Size="CardSize.ExtraLarge" class="max-w-none">
                    <div class="p-4 sm:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white">Campaigns</h5>
                            @if (campaigns.Any())
                            {
                                <span class="text-sm text-gray-500 dark:text-gray-400">
                                    @campaigns.Count campaign(s)
                                </span>
                            }
                        </div>
                        
                        @if (isLoading)
                        {
                            <div class="flex items-center justify-center py-8">
                                <Spinner Size="SpinnerSize.Lg" />
                            </div>
                        }
                        else if (campaigns.Any())
                        {
                            <div class="flow-root">
                                <ul class="divide-y divide-gray-200 dark:divide-gray-700">
                                    @foreach (var campaign in campaigns)
                                    {
                                        <li class="py-3 sm:py-4">
                                            <div class="flex items-center space-x-4">
                                                <div class="flex-shrink-0">
                                                    <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-primary-100 dark:bg-primary-900">
                                                        <BookOpenIcon Class="w-5 h-5 text-primary-600 dark:text-primary-400" />
                                                    </div>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm font-medium text-gray-900 truncate dark:text-white">
                                                        @campaign.Name
                                                    </p>
                                                    <p class="text-sm text-gray-500 truncate dark:text-gray-400">
                                                        @GetLocationDisplay(campaign) â€¢ @GetTimeAgo(campaign.LastActivityAt)
                                                    </p>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    @if (campaign.PartyState.Any())
                                                    {
                                                        <span class="inline-flex items-center px-3 py-2.5 text-xs font-medium text-indigo-800 bg-indigo-100 rounded-lg dark:bg-indigo-900 dark:text-indigo-300">@campaign.PartyState.Count PCs</span>
                                                    }
                                                    <Button Href="@($"/dm/{campaign.Id}")" Color="ButtonColor.Primary" Size="ButtonSize.Small">
                                                        Play
                                                    </Button>
                                                    <Button Style="ButtonStyle.Outline" Color="ButtonColor.Dark" Size="ButtonSize.Small" Class="py-2.5"
                                                            @onclick="() => ShowEditModal(campaign)">
                                                        <EditIcon Class="w-4 h-4" />
                                                    </Button>
                                                    <Button Style="ButtonStyle.Outline" Color="ButtonColor.Dark" Size="ButtonSize.Small" Class="py-2.5"
                                                            @onclick="() => ShowDeleteConfirmation(campaign)">
                                                        <TrashBinIcon Class="w-4 h-4" />
                                                    </Button>
                                                </div>
                                            </div>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-8">
                                <BookOpenIcon Class="mx-auto h-12 w-12 text-gray-400" />
                                <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No campaigns yet</h3>
                                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by creating a new campaign.</p>
                                <div class="mt-6">
                                    <Button Href="/campaigns/new" Color="ButtonColor.Primary">
                                        <PlusIcon Class="mr-2 h-4 w-4" />
                                        New Campaign
                                    </Button>
                                </div>
                            </div>
                        }
                    </div>
                </Card>
            </section>

            <section>
                <Card Size="CardSize.ExtraLarge" class="max-w-none">
                    <div class="p-4 sm:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h5 class="text-xl font-bold leading-none text-gray-900 dark:text-white">Quick Actions</h5>
                        </div>
                        
                        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                            <Button Href="/campaigns/new" Color="ButtonColor.Primary" Class="w-full justify-center">
                                <PlusIcon Class="mr-2 h-5 w-5" />
                                Start New Campaign
                            </Button>
                            <Button Href="/test/data-model" Color="ButtonColor.Light" Class="w-full justify-center">
                                <ClipboardIcon Class="mr-2 h-5 w-5" />
                                Data Model Test
                            </Button>
                            <Button Color="ButtonColor.Light" Class="w-full justify-center" Disabled>
                                <UsersIcon Class="mr-2 h-5 w-5" />
                                Manage Characters (Coming Soon)
                            </Button>
                        </div>
                    </div>
                </Card>
            </section>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
            <div class="max-w-md">
                <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
                    Welcome to Riddle
                </h1>
                <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">
                    Your AI-powered Dungeon Master assistant for D&D 5th Edition. 
                    Sign in to start your adventure.
                </p>
                <Button Href="/Account/Login" Color="ButtonColor.Primary" Size="ButtonSize.Large" Class="w-full sm:w-auto">
                    Sign in with Google
                </Button>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

@* Edit Campaign Modal *@
<Modal @bind-Show="_showEditModal" Size="ModalSize.Large">
    <ModalHeader>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            Edit Campaign Settings
        </h3>
    </ModalHeader>
    <ModalBody>
        <Tabs Variant="TabVariant.Underline">
            <TabListContent>
                <Tab Index="0">General</Tab>
                <Tab Index="1">Preferences</Tab>
            </TabListContent>
            <TabPanelsContent>
                <TabPanel Index="0">
                    <div class="space-y-4 pt-4">
                        <div>
                            <Label For="campaignName" Value="Campaign Name" />
                            <TextInput Id="campaignName" @bind-Value="_editModel.Name" Placeholder="My Campaign" />
                        </div>
                        <div>
                            <Label For="campaignModule" Value="Campaign Module" />
                            <TextInput Id="campaignModule" Value="@_editModel.CampaignModule" Disabled="true" 
                                       class="bg-gray-100 dark:bg-gray-600 cursor-not-allowed" />
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Campaign module cannot be changed after creation.
                            </p>
                        </div>
                    </div>
                </TabPanel>
                <TabPanel Index="1">
                    <div class="space-y-4 pt-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <Label For="combatFocus" Value="Combat Focus" />
                                <Select Id="combatFocus" @bind-Value="_editModel.CombatFocus">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </Select>
                            </div>
                            <div>
                                <Label For="roleplayFocus" Value="Roleplay Focus" />
                                <Select Id="roleplayFocus" @bind-Value="_editModel.RoleplayFocus">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </Select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <Label For="pacing" Value="Pacing" />
                                <Select Id="pacing" @bind-Value="_editModel.Pacing">
                                    <option value="Fast">Fast</option>
                                    <option value="Methodical">Methodical</option>
                                </Select>
                            </div>
                            <div>
                                <Label For="tone" Value="Tone" />
                                <Select Id="tone" @bind-Value="_editModel.Tone">
                                    <option value="Adventurous">Adventurous</option>
                                    <option value="Dark">Dark</option>
                                    <option value="Comedic">Comedic</option>
                                </Select>
                            </div>
                        </div>
                        <div>
                            <Label For="avoidedTopics" Value="Avoided Topics" />
                            <TextInput Id="avoidedTopics" @bind-Value="_editModel.AvoidedTopics" 
                                       Placeholder="e.g., spiders, drowning (comma-separated)" />
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                Topics the party wants to avoid. Separate multiple topics with commas.
                            </p>
                        </div>
                    </div>
                </TabPanel>
            </TabPanelsContent>
        </Tabs>
    </ModalBody>
    <ModalFooter>
        <div class="flex justify-end gap-3">
            <Button Color="ButtonColor.Light" @onclick="CancelEdit">
                Cancel
            </Button>
            <Button Color="ButtonColor.Primary" @onclick="SaveChanges" Disabled="_isSaving">
                @if (_isSaving)
                {
                    <Spinner Size="SpinnerSize.Sm" class="mr-2" />
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save Changes</span>
                }
            </Button>
        </div>
    </ModalFooter>
</Modal>

@* Delete Confirmation Modal *@
<Modal @bind-Show="_showDeleteModal" Size="ModalSize.Small">
    <ModalHeader>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
            Delete Campaign
        </h3>
    </ModalHeader>
    <ModalBody>
        <div class="text-center">
            <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900">
                <ExclamationCircleIcon Class="h-6 w-6 text-red-600 dark:text-red-400" />
            </div>
            <p class="mb-2 text-gray-500 dark:text-gray-400">
                Are you sure you want to delete
            </p>
            <p class="mb-4 font-semibold text-gray-900 dark:text-white">
                @_campaignToDelete?.Name
            </p>
            <p class="text-sm text-gray-500 dark:text-gray-400">
                This action cannot be undone. All campaign data, including characters and combat history, will be permanently deleted.
            </p>
        </div>
    </ModalBody>
    <ModalFooter>
        <div class="flex justify-center gap-4">
            <Button Color="ButtonColor.Light" @onclick="CancelDelete">
                Cancel
            </Button>
            <Button Color="ButtonColor.Red" @onclick="ConfirmDelete" Disabled="_isDeleting">
                @if (_isDeleting)
                {
                    <Spinner Size="SpinnerSize.Sm" class="mr-2" />
                    <span>Deleting...</span>
                }
                else
                {
                    <span>Yes, delete</span>
                }
            </Button>
        </div>
    </ModalFooter>
</Modal>

@code {
    private List<CampaignInstance> campaigns = new();
    private bool isLoading = true;
    private int campaignCount = 0;
    private int characterCount = 0;
    private string lastActivityText = "No activity";
    private string lastCampaignName = "";
    private string? currentUserId;
    
    // Delete confirmation modal state
    private bool _showDeleteModal = false;
    private CampaignInstance? _campaignToDelete;
    private bool _isDeleting = false;
    
    // Edit modal state
    private bool _showEditModal = false;
    private CampaignInstance? _campaignToEdit;
    private CampaignEditModel _editModel = new();
    private bool _isSaving = false;
    
    // Edit model class to hold form values
    private class CampaignEditModel
    {
        public string Name { get; set; } = "";
        public string CampaignModule { get; set; } = "";
        public string CombatFocus { get; set; } = "Medium";
        public string RoleplayFocus { get; set; } = "Medium";
        public string Pacing { get; set; } = "Methodical";
        public string Tone { get; set; } = "Adventurous";
        public string AvoidedTopics { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            
            if (!string.IsNullOrEmpty(currentUserId))
            {
                await LoadCampaignsAsync();
            }
        }
        
        isLoading = false;
    }

    private async Task LoadCampaignsAsync()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;
        
        campaigns = await CampaignService.GetCampaignsForUserAsync(currentUserId);
        campaignCount = campaigns.Count;
        characterCount = campaigns.Sum(c => c.PartyState.Count);
        
        var mostRecent = campaigns.FirstOrDefault();
        if (mostRecent != null)
        {
            lastActivityText = GetTimeAgo(mostRecent.LastActivityAt);
            lastCampaignName = mostRecent.Name;
        }
    }

    private string GetLocationDisplay(CampaignInstance campaign)
    {
        // Convert location ID to human-readable format
        return campaign.CurrentLocationId.Replace("_", " ").ToUpperInvariant() switch
        {
            var x when x.Contains("GOBLIN") => "Goblin Ambush",
            var x when x.Contains("PHANDALIN") => "Phandalin",
            var x when x.Contains("CRAGMAW") => "Cragmaw Hideout",
            var x when x.Contains("REDBRAND") => "Redbrand Hideout",
            _ => campaign.CurrentLocationId.Replace("_", " ")
        };
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        return timeSpan switch
        {
            { TotalMinutes: < 1 } => "Just now",
            { TotalMinutes: < 60 } => $"{(int)timeSpan.TotalMinutes}m ago",
            { TotalHours: < 24 } => $"{(int)timeSpan.TotalHours}h ago",
            { TotalDays: < 7 } => $"{(int)timeSpan.TotalDays}d ago",
            { TotalDays: < 30 } => $"{(int)(timeSpan.TotalDays / 7)}w ago",
            _ => $"{(int)(timeSpan.TotalDays / 30)}mo ago"
        };
    }
    
    private void ShowDeleteConfirmation(CampaignInstance campaign)
    {
        _campaignToDelete = campaign;
        _showDeleteModal = true;
    }
    
    private void CancelDelete()
    {
        _showDeleteModal = false;
        _campaignToDelete = null;
    }
    
    private async Task ConfirmDelete()
    {
        if (_campaignToDelete == null) return;
        
        _isDeleting = true;
        try
        {
            await CampaignService.DeleteCampaignAsync(_campaignToDelete.Id);
            _showDeleteModal = false;
            _campaignToDelete = null;
            
            // Refresh campaign list
            await LoadCampaignsAsync();
        }
        finally
        {
            _isDeleting = false;
        }
    }
    
    private void ShowEditModal(CampaignInstance campaign)
    {
        _campaignToEdit = campaign;
        
        // Clone campaign data into edit model
        _editModel = new CampaignEditModel
        {
            Name = campaign.Name,
            CampaignModule = campaign.CampaignModule,
            CombatFocus = campaign.Preferences.CombatFocus,
            RoleplayFocus = campaign.Preferences.RoleplayFocus,
            Pacing = campaign.Preferences.Pacing,
            Tone = campaign.Preferences.Tone,
            AvoidedTopics = string.Join(", ", campaign.Preferences.AvoidedTopics)
        };
        
        _showEditModal = true;
    }
    
    private void CancelEdit()
    {
        _showEditModal = false;
        _campaignToEdit = null;
        _editModel = new();
    }
    
    private async Task SaveChanges()
    {
        if (_campaignToEdit == null) return;
        
        _isSaving = true;
        try
        {
            // Update campaign name
            _campaignToEdit.Name = _editModel.Name;
            
            // Update preferences
            var prefs = _campaignToEdit.Preferences;
            prefs.CombatFocus = _editModel.CombatFocus;
            prefs.RoleplayFocus = _editModel.RoleplayFocus;
            prefs.Pacing = _editModel.Pacing;
            prefs.Tone = _editModel.Tone;
            prefs.AvoidedTopics = _editModel.AvoidedTopics
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();
            _campaignToEdit.Preferences = prefs;
            
            // Update last activity
            _campaignToEdit.LastActivityAt = DateTime.UtcNow;
            
            // Save to database
            await CampaignService.UpdateCampaignAsync(_campaignToEdit);
            
            _showEditModal = false;
            _campaignToEdit = null;
            _editModel = new();
            
            // Refresh campaign list
            await LoadCampaignsAsync();
        }
        finally
        {
            _isSaving = false;
        }
    }
}

@page "/dm/{SessionId:guid}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Riddle.Web.Services
@using Riddle.Web.Models
@inject ISessionService SessionService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>@(session?.CampaignName ?? "Session") - Riddle</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (isLoading)
        {
            <div class="flex items-center justify-center min-h-[60vh]">
                <div class="text-center">
                    <Spinner Size="SpinnerSize.Xl" class="mx-auto" />
                    <p class="mt-4 text-gray-500 dark:text-gray-400">Loading session...</p>
                </div>
            </div>
        }
        else if (session == null)
        {
            <div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
                <div class="max-w-md">
                    <ExclamationTriangleIcon Class="mx-auto h-16 w-16 text-yellow-500" />
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white mt-4 mb-2">
                        Session Not Found
                    </h1>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        The session you're looking for doesn't exist or you don't have access to it.
                    </p>
                    <Button Href="/" Color="ButtonColor.Primary">
                        <HomeIcon Class="mr-2 h-5 w-5" />
                        Return to Dashboard
                    </Button>
                </div>
            </div>
        }
        else
        {
            <div class="space-y-4">
                <!-- Session Header -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <Button Href="/" Color="ButtonColor.Light" Size="ButtonSize.Small">
                            <ChevronLeftIcon Class="h-4 w-4" />
                        </Button>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                                @session.CampaignName
                            </h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                @GetLocationDisplay() • Chapter @session.CurrentChapterId.Replace("chapter_", "")
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <Badge Color="BadgeColor.Success">Active</Badge>
                    </div>
                </div>
                
                <!-- Main Content Area (Placeholder) -->
                <div class="grid gap-4 lg:grid-cols-3">
                    <!-- Left Column - Main Content -->
                    <div class="lg:col-span-2 space-y-4">
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-6">
                                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                                    <PlayIcon Class="inline-block w-5 h-5 mr-2" />
                                    DM Interface
                                </h2>
                                <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-8 text-center">
                                    <RocketIcon Class="mx-auto h-16 w-16 text-gray-400 dark:text-gray-600" />
                                    <h3 class="mt-4 text-lg font-medium text-gray-900 dark:text-white">
                                        Coming Soon
                                    </h3>
                                    <p class="mt-2 text-gray-500 dark:text-gray-400">
                                        The AI-powered DM interface will be implemented in Phase 2.
                                        This will include narrative generation, combat management, and player choice handling.
                                    </p>
                                </div>
                            </div>
                        </Card>
                        
                        <!-- Read-Aloud Section (Placeholder) -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-6">
                                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                                    <BookOpenIcon Class="inline-block w-5 h-5 mr-2" />
                                    Read-Aloud Text
                                </h2>
                                @if (!string.IsNullOrEmpty(session.CurrentReadAloudText))
                                {
                                    <div class="bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-500 p-4 italic text-gray-700 dark:text-gray-300">
                                        @session.CurrentReadAloudText
                                    </div>
                                }
                                else
                                {
                                    <p class="text-gray-500 dark:text-gray-400">
                                        No read-aloud text available. Start the session to generate narrative content.
                                    </p>
                                }
                            </div>
                        </Card>
                    </div>
                    
                    <!-- Right Column - Sidebar -->
                    <div class="space-y-4">
                        <!-- Party Panel -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-4">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                    <UsersIcon Class="inline-block w-4 h-4 mr-2" />
                                    Party (@session.PartyState.Count)
                                </h3>
                                @if (session.PartyState.Any())
                                {
                                    <ul class="space-y-2">
                                        @foreach (var character in session.PartyState)
                                        {
                                            <li class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded">
                                                <div>
                                                    <p class="font-medium text-gray-900 dark:text-white text-sm">@character.Name</p>
                                                    <p class="text-xs text-gray-500 dark:text-gray-400">@character.Type • AC @character.ArmorClass</p>
                                                </div>
                                                <span class="text-xs font-medium text-green-600 dark:text-green-400">
                                                    @character.CurrentHp/@character.MaxHp HP
                                                </span>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-sm text-gray-500 dark:text-gray-400">No characters added yet.</p>
                                    <Button Size="ButtonSize.Small" Color="ButtonColor.Light" Class="mt-2 w-full">
                                        <PlusIcon Class="h-4 w-4 mr-1" /> Add Character
                                    </Button>
                                }
                            </div>
                        </Card>
                        
                        <!-- Active Quests -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-4">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                    <ClipboardIcon Class="inline-block w-4 h-4 mr-2" />
                                    Active Quests (@session.ActiveQuests.Count)
                                </h3>
                                @if (session.ActiveQuests.Any())
                                {
                                    <ul class="space-y-2">
                                        @foreach (var quest in session.ActiveQuests)
                                        {
                                            <li class="p-2 bg-gray-50 dark:bg-gray-800 rounded">
                                                <p class="font-medium text-gray-900 dark:text-white text-sm">@quest.Title</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">@quest.State</p>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-sm text-gray-500 dark:text-gray-400">No active quests.</p>
                                }
                            </div>
                        </Card>
                        
                        <!-- Session Info -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-4">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                    <InfoCircleIcon Class="inline-block w-4 h-4 mr-2" />
                                    Session Info
                                </h3>
                                <dl class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500 dark:text-gray-400">Created</dt>
                                        <dd class="text-gray-900 dark:text-white">@session.CreatedAt.ToString("MMM d, yyyy")</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500 dark:text-gray-400">Last Activity</dt>
                                        <dd class="text-gray-900 dark:text-white">@GetTimeAgo(session.LastActivityAt)</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500 dark:text-gray-400">Milestones</dt>
                                        <dd class="text-gray-900 dark:text-white">@session.CompletedMilestones.Count completed</dd>
                                    </div>
                                </dl>
                            </div>
                        </Card>
                    </div>
                </div>
            </div>
        }
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public Guid SessionId { get; set; }
    
    private RiddleSession? session;
    private bool isLoading = true;
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            await LoadSessionAsync();
        }
        
        isLoading = false;
    }

    private async Task LoadSessionAsync()
    {
        session = await SessionService.GetSessionAsync(SessionId);
        
        // Verify the user owns this session
        if (session != null && session.DmUserId != currentUserId)
        {
            session = null; // Don't show sessions the user doesn't own
        }
    }

    private string GetLocationDisplay()
    {
        if (session == null) return "";
        
        return session.CurrentLocationId.Replace("_", " ").ToUpperInvariant() switch
        {
            var x when x.Contains("GOBLIN") => "Goblin Ambush",
            var x when x.Contains("PHANDALIN") => "Phandalin",
            var x when x.Contains("CRAGMAW") => "Cragmaw Hideout",
            var x when x.Contains("REDBRAND") => "Redbrand Hideout",
            _ => session.CurrentLocationId.Replace("_", " ")
        };
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        return timeSpan switch
        {
            { TotalMinutes: < 1 } => "Just now",
            { TotalMinutes: < 60 } => $"{(int)timeSpan.TotalMinutes}m ago",
            { TotalHours: < 24 } => $"{(int)timeSpan.TotalHours}h ago",
            { TotalDays: < 7 } => $"{(int)timeSpan.TotalDays}d ago",
            { TotalDays: < 30 } => $"{(int)(timeSpan.TotalDays / 7)}w ago",
            _ => dateTime.ToString("MMM d, yyyy")
        };
    }
}

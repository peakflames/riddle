@page "/dm/{CampaignId:guid}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Riddle.Web.Services
@using Riddle.Web.Models
@using Riddle.Web.Components.Chat
@using Riddle.Web.Components.Debug
@using Riddle.Web.Components.Characters
@using Riddle.Web.Components.Shared
@implements IDisposable
@inject ICampaignService CampaignService
@inject IGameStateService GameStateService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>@(campaign?.Name ?? "Campaign") - Riddle</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (isLoading)
        {
            <div class="flex items-center justify-center min-h-[60vh]">
                <div class="text-center">
                    <Spinner Size="SpinnerSize.Xl" class="mx-auto" />
                    <p class="mt-4 text-gray-500 dark:text-gray-400">Loading campaign...</p>
                </div>
            </div>
        }
        else if (campaign == null)
        {
            <div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
                <div class="max-w-md">
                    <ExclamationTriangleIcon Class="mx-auto h-16 w-16 text-yellow-500" />
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white mt-4 mb-2">
                        Campaign Not Found
                    </h1>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        The campaign you're looking for doesn't exist or you don't have access to it.
                    </p>
                    <Button Href="/" Color="ButtonColor.Primary">
                        <HomeIcon Class="mr-2 h-5 w-5" />
                        Return to Dashboard
                    </Button>
                </div>
            </div>
        }
        else
        {
            <div class="space-y-4">
                <!-- Campaign Header -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <Button Href="/" Color="ButtonColor.Light" Size="ButtonSize.Small">
                            <ChevronLeftIcon Class="h-4 w-4" />
                        </Button>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                                @campaign.Name
                            </h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                @GetLocationDisplay() â€¢ Chapter @campaign.CurrentChapterId.Replace("chapter_", "")
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <Button Color="ButtonColor.Light" Size="ButtonSize.Small" OnClick="@OpenInviteModal">
                            <ShareNodesIcon Class="w-4 h-4 mr-2" />
                            Invite Players
                        </Button>
                        <Badge Color="BadgeColor.Success">Active</Badge>
                    </div>
                </div>
                
                <!-- Main Content Area -->
                <div class="grid gap-4 lg:grid-cols-3 lg:h-[calc(100vh-180px)]">
                    <!-- Left Column - DM Chat (Full Height) -->
                    <div class="lg:col-span-2 h-full overflow-auto">
                        <Card Size="CardSize.ExtraLarge" class="max-w-none h-full">
                            <div class="p-4 h-full flex flex-col">
                                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex-none">
                                    <MessageDotsIcon Class="inline-block w-5 h-5 mr-2" />
                                    DM Chat
                                </h2>
                                <div class="flex-1 min-h-0">
                                    <DmChat CampaignId="@CampaignId" />
                                </div>
                            </div>
                        </Card>
                    </div>
                    
                    <!-- Right Column - Sidebar -->
                    <div class="space-y-4">
                        <!-- Party Panel -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-4">
                                <CharacterList 
                                    Characters="@campaign.PartyState"
                                    OnAddClick="@OpenAddCharacterModal"
                                    OnEdit="@OpenEditCharacterModal"
                                    OnRemove="@HandleRemoveCharacter" />
                            </div>
                        </Card>
                        
                        <!-- Active Quests -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-4">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                    <ClipboardIcon Class="inline-block w-4 h-4 mr-2" />
                                    Active Quests (@campaign.ActiveQuests.Count)
                                </h3>
                                @if (campaign.ActiveQuests.Any())
                                {
                                    <ul class="space-y-2">
                                        @foreach (var quest in campaign.ActiveQuests)
                                        {
                                            <li class="p-2 bg-gray-50 dark:bg-gray-800 rounded">
                                                <p class="font-medium text-gray-900 dark:text-white text-sm">@quest.Title</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">@quest.State</p>
                                            </li>
                                        }
                                    </ul>
                                }
                                else
                                {
                                    <p class="text-sm text-gray-500 dark:text-gray-400">No active quests.</p>
                                }
                            </div>
                        </Card>
                        
                        <!-- Campaign Info -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-4">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                    <InfoCircleIcon Class="inline-block w-4 h-4 mr-2" />
                                    Campaign Info
                                </h3>
                                <dl class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500 dark:text-gray-400">Created</dt>
                                        <dd class="text-gray-900 dark:text-white">@campaign.CreatedAt.ToString("MMM d, yyyy")</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500 dark:text-gray-400">Last Activity</dt>
                                        <dd class="text-gray-900 dark:text-white">@GetTimeAgo(campaign.LastActivityAt)</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500 dark:text-gray-400">Milestones</dt>
                                        <dd class="text-gray-900 dark:text-white">@campaign.CompletedMilestones.Count completed</dd>
                                    </div>
                                </dl>
                            </div>
                        </Card>
                        
                        <!-- Read-Aloud Text (moved from left column) -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-4">
                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                    <BookOpenIcon Class="inline-block w-4 h-4 mr-2" />
                                    Read-Aloud Text
                                </h3>
                                @if (!string.IsNullOrEmpty(campaign.CurrentReadAloudText))
                                {
                                    <div class="bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-500 p-3 italic text-gray-700 dark:text-gray-300 text-sm">
                                        @campaign.CurrentReadAloudText
                                    </div>
                                }
                                else
                                {
                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                        No read-aloud text available. Start session to generate narrative content.
                                    </p>
                                }
                            </div>
                        </Card>
                        
                        <!-- Event Log (Debug Panel) -->
                        <AppEventLog />
                    </div>
                </div>
            </div>
            
            <!-- Character Form Modal -->
            <CharacterFormModal 
                @bind-Show="_showCharacterModal"
                EditingCharacter="@_editingCharacter"
                OnSave="@HandleSaveCharacter" />
            
            <!-- Invite Link Modal -->
            <InviteLinkModal 
                @bind-Show="_showInviteModal"
                Campaign="@campaign"
                OnInviteCodeRegenerated="@HandleInviteCodeRegenerated" />
        }
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    [Parameter]
    public Guid CampaignId { get; set; }
    
    private CampaignInstance? campaign;
    private bool isLoading = true;
    private string? currentUserId;
    
    // Character management state
    private bool _showCharacterModal;
    private Character? _editingCharacter;
    
    // Invite modal state
    private bool _showInviteModal;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to campaign state changes for real-time updates
        GameStateService.OnCampaignChanged += HandleCampaignChanged;
        
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            await LoadCampaignAsync();
        }
        
        isLoading = false;
    }

    private void HandleCampaignChanged(CampaignChangedEventArgs args)
    {
        // Only process changes for the current campaign
        if (campaign == null || args.CampaignId != CampaignId) return;
        
        InvokeAsync(() =>
        {
            switch (args.ChangedProperty)
            {
                case "CurrentReadAloudText":
                    campaign.CurrentReadAloudText = args.NewValue as string ?? "";
                    break;
                case "ActivePlayerChoices":
                    if (args.NewValue is List<string> choices)
                        campaign.ActivePlayerChoices = choices;
                    break;
                case "CurrentSceneImageUri":
                    campaign.CurrentSceneImageUri = args.NewValue as string;
                    break;
            }
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        GameStateService.OnCampaignChanged -= HandleCampaignChanged;
    }

    private async Task LoadCampaignAsync()
    {
        campaign = await CampaignService.GetCampaignAsync(CampaignId);
        
        // Verify user owns this campaign
        if (campaign != null && campaign.DmUserId != currentUserId)
        {
            campaign = null; // Don't show campaigns user doesn't own
        }
    }

    private string GetLocationDisplay()
    {
        if (campaign == null) return "";
        
        return campaign.CurrentLocationId.Replace("_", " ").ToUpperInvariant() switch
        {
            var x when x.Contains("GOBLIN") => "Goblin Ambush",
            var x when x.Contains("PHANDALIN") => "Phandalin",
            var x when x.Contains("CRAGMAW") => "Cragmaw Hideout",
            var x when x.Contains("REDBRAND") => "Redbrand Hideout",
            _ => campaign.CurrentLocationId.Replace("_", " ")
        };
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        return timeSpan switch
        {
            { TotalMinutes: < 1 } => "Just now",
            { TotalMinutes: < 60 } => $"{(int)timeSpan.TotalMinutes}m ago",
            { TotalHours: < 24 } => $"{(int)timeSpan.TotalHours}h ago",
            { TotalDays: < 7 } => $"{(int)timeSpan.TotalDays}d ago",
            { TotalDays: < 30 } => $"{(int)(timeSpan.TotalDays / 7)}w ago",
            _ => dateTime.ToString("MMM d, yyyy")
        };
    }
    
    // Character Management Methods
    private void OpenAddCharacterModal()
    {
        _editingCharacter = null;
        _showCharacterModal = true;
    }
    
    private void OpenEditCharacterModal(Character character)
    {
        _editingCharacter = character;
        _showCharacterModal = true;
    }
    
    private async Task HandleSaveCharacter(Character character)
    {
        if (campaign == null) return;
        
        // Get the current party list (deserialized from JSON)
        var party = campaign.PartyState;
        
        if (_editingCharacter == null)
        {
            // Add new character
            party.Add(character);
        }
        else
        {
            // Update existing character in the list
            var index = party.FindIndex(c => c.Id == character.Id);
            if (index >= 0)
            {
                party[index] = character;
            }
        }
        
        // Set back to serialize to JSON
        campaign.PartyState = party;
        
        // Save to database
        await CampaignService.UpdateCampaignAsync(campaign);
        StateHasChanged();
    }
    
    private async Task HandleRemoveCharacter(Character character)
    {
        if (campaign == null) return;
        
        // Get the current party list (deserialized from JSON)
        var party = campaign.PartyState;
        party.RemoveAll(c => c.Id == character.Id);
        
        // Set back to serialize to JSON
        campaign.PartyState = party;
        
        await CampaignService.UpdateCampaignAsync(campaign);
        StateHasChanged();
    }
    
    // Invite Modal Methods
    private void OpenInviteModal()
    {
        _showInviteModal = true;
    }
    
    private void HandleInviteCodeRegenerated(string newCode)
    {
        // Campaign object is already updated by the modal
        StateHasChanged();
    }
}

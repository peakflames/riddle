@page "/dm/{CampaignId:guid}"
@layout StackedLayout
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Riddle.Web.Services
@using Riddle.Web.Models
@using Riddle.Web.Components.Chat
@using Riddle.Web.Components.Debug
@using Riddle.Web.Components.Characters
@using Riddle.Web.Components.Shared
@using Riddle.Web.Components.Combat
@using Riddle.Web.Hubs
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@inject ICampaignService CampaignService
@inject ICharacterService CharacterService
@inject IGameStateService GameStateService
@inject ICombatService CombatService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>@(campaign?.Name ?? "Campaign") - Riddle</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (isLoading)
        {
            <div class="flex items-center justify-center min-h-[60vh]">
                <div class="text-center">
                    <Spinner Size="SpinnerSize.Xl" class="mx-auto" />
                    <p class="mt-4 text-gray-500 dark:text-gray-400">Loading campaign...</p>
                </div>
            </div>
        }
        else if (campaign == null)
        {
            <div class="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
                <div class="max-w-md">
                    <ExclamationTriangleIcon Class="mx-auto h-16 w-16 text-yellow-500" />
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white mt-4 mb-2">
                        Campaign Not Found
                    </h1>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        The campaign you're looking for doesn't exist or you don't have access to it.
                    </p>
                    <Button Href="/" Color="ButtonColor.Primary">
                        <HomeIcon Class="mr-2 h-5 w-5" />
                        Return to Dashboard
                    </Button>
                </div>
            </div>
        }
        else
        {
            <div class="space-y-4">
                <!-- Campaign Header -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <Button Href="/" Color="ButtonColor.Light" Size="ButtonSize.Small">
                            <ChevronLeftIcon Class="h-4 w-4" />
                        </Button>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
                                @campaign.Name
                            </h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                @GetLocationDisplay() ‚Ä¢ Chapter @campaign.CurrentChapterId.Replace("chapter_", "")
                            </p>
                        </div>
                    </div>
                    <Badge Color="BadgeColor.Success">Active</Badge>
                </div>
                
                <!-- Main Content Area - 4 Column Layout -->
                <div class="grid gap-4 lg:grid-cols-4 lg:h-full">
                    <!-- Column 1 - DM Chat (Full Height) -->
                    <div class="h-[calc(100vh-200px)] overflow-hidden">
                        <Card Size="CardSize.ExtraLarge" class="max-w-none h-full">
                            <div class="p-4 h-full flex flex-col">
                                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex-none">
                                    <MessageDotsIcon Class="inline-block w-5 h-5 mr-2" />
                                    DM Chat
                                </h2>
                                <div class="flex-1 min-h-0">
                                    <DmChat CampaignId="@CampaignId" />
                                </div>
                            </div>
                        </Card>
                    </div>
                    
                    <!-- Column 2 - Read-Aloud, Player Choices, Recent Rolls (scrollable) -->
                    <div class="h-[calc(100vh-200px)] overflow-auto space-y-4">
                        <!-- Read-Aloud Text -->
                                    <Card Size="CardSize.ExtraLarge" class="max-w-none">
                                        <div class="p-4">
                                            <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                                <BookOpenIcon Class="inline-block w-4 h-4 mr-2" />
                                                Read-Aloud Text
                                            </h3>
                                            @if (!string.IsNullOrEmpty(campaign.CurrentReadAloudText))
                                            {
                                                @* Tone/Pacing badges *@
                                                @if (!string.IsNullOrEmpty(campaign.CurrentReadAloudTone) || !string.IsNullOrEmpty(campaign.CurrentReadAloudPacing))
                                                {
                                                    <div class="flex flex-wrap gap-2 mb-2">
                                                        @if (!string.IsNullOrEmpty(campaign.CurrentReadAloudTone))
                                                        {
                                                            <Badge Color="@GetToneBadgeColor(campaign.CurrentReadAloudTone)" Size="BadgeSize.Small">
                                                                üé≠ @campaign.CurrentReadAloudTone
                                                            </Badge>
                                                        }
                                                        @if (!string.IsNullOrEmpty(campaign.CurrentReadAloudPacing))
                                                        {
                                                            <Badge Color="@GetPacingBadgeColor(campaign.CurrentReadAloudPacing)" Size="BadgeSize.Small">
                                                                ‚è±Ô∏è @campaign.CurrentReadAloudPacing
                                                            </Badge>
                                                        }
                                                    </div>
                                                }
                                                <div class="bg-amber-50 dark:bg-amber-900/20 border-l-4 border-amber-500 p-3 italic text-gray-700 dark:text-gray-300 text-lg">
                                                    @campaign.CurrentReadAloudText
                                                </div>
                                            }
                                            else
                                            {
                                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                                    No read-aloud text available. Start session to generate narrative content.
                                                </p>
                                            }
                                        </div>
                                    </Card>
                        
                        <!-- Player Choices (DM Preview) -->
                                    <Card Size="CardSize.ExtraLarge" class="max-w-none">
                                        <div class="p-4">
                                            <div class="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-gray-700 mb-3">
                                                <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                                    <CheckCircleIcon Class="w-4 h-4" />
                                                    Player Choices
                                                    @if (campaign.ActivePlayerChoices?.Any() == true)
                                                    {
                                                        <Badge Color="BadgeColor.Gray" Size="BadgeSize.ExtraSmall">
                                                            @GetRespondedCount()/@GetTotalPlayersCount() responded
                                                        </Badge>
                                                    }
                                                </h3>
                                            </div>
                                            @if (campaign.ActivePlayerChoices?.Any() == true)
                                            {
                                                @* Per-Choice Breakdown with Player Names *@
                                                <div class="space-y-2">
                                                    @foreach (var choice in campaign.ActivePlayerChoices)
                                                    {
                                                        var playersWhoChose = GetPlayersWhoChose(choice);
                                                        var hasResponses = playersWhoChose.Any();
                                                        <div class="flex items-start gap-2 py-1.5">
                                                            @* Bullet indicator - filled if someone chose this *@
                                                            <span class="mt-0.5 flex-shrink-0">
                                                                @if (hasResponses)
                                                                {
                                                                    <span class="inline-block w-2 h-2 rounded-full bg-primary-500"></span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="inline-block w-2 h-2 rounded-full border border-gray-400 dark:border-gray-500"></span>
                                                                }
                                                            </span>
                                                            @* Choice text *@
                                                            <span class="font-medium text-gray-900 dark:text-white text-sm min-w-[80px]">@choice</span>
                                                            @* Player names who chose this option *@
                                                            <div class="flex flex-wrap gap-1 flex-1">
                                                                @foreach (var playerChoice in playersWhoChose)
                                                                {
                                                                    <Badge Color="BadgeColor.Success" Size="BadgeSize.ExtraSmall">
                                                                        @playerChoice.CharacterName ‚úì
                                                                    </Badge>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                                
                                                @* Waiting For Section *@
                                                @if (GetWaitingPlayers() is var waitingPlayers && waitingPlayers.Any())
                                                {
                                                    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                                                        <div class="flex items-center gap-2 text-sm">
                                                            <span class="text-gray-500 dark:text-gray-400">Waiting:</span>
                                                            <div class="flex flex-wrap gap-1">
                                                                @foreach (var player in waitingPlayers)
                                                                {
                                                                    <Badge Color="BadgeColor.Warning" Size="BadgeSize.ExtraSmall">
                                                                        @player.Name
                                                                    </Badge>
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                                                        <Badge Color="BadgeColor.Success" Size="BadgeSize.Small">
                                                            ‚úì All players have responded
                                                        </Badge>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="flex flex-col items-center justify-center text-center py-6">
                                                    <CheckCircleIcon Class="w-10 h-10 text-gray-300 dark:text-gray-600 mb-3" />
                                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                                        No active choices for players
                                                    </p>
                                                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                                        Choices appear when the AI presents options to the party
                                                    </p>
                                                </div>
                                            }
                                        </div>
                                    </Card>
                        
                        <!-- Recent Dice Rolls -->
                                    <Card Size="CardSize.ExtraLarge" class="max-w-none">
                                        <div class="p-4">
                                            <div class="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-gray-700 mb-3">
                                                <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                                    </svg>
                                                    Recent @MaxRecentRolls Rolls
                                                    <Badge Color="BadgeColor.Gray" Size="BadgeSize.ExtraSmall">@(campaign.RecentRolls?.Count ?? 0)</Badge>
                                                </h3>
                                            </div>
                                            @if (campaign.RecentRolls?.Any() == true)
                                            {
                                                <div class="max-h-80 overflow-y-auto">
                                                @foreach (var roll in campaign.RecentRolls.Take(MaxRecentRolls))
                                                    {
                                                        <div class="flex items-center gap-2 py-1.5 px-2 rounded hover:bg-gray-50 dark:hover:bg-gray-800/50 text-sm">
                                                            <span class="font-medium text-gray-900 dark:text-white truncate max-w-[150px]" title="@roll.CharacterName">@roll.CharacterName</span>
                                                            <span class="text-gray-400 flex-shrink-0">|</span>
                                                            <span class="text-gray-600 dark:text-gray-400 truncate flex-1" title="@roll.CheckType">@roll.CheckType</span>
                                                            <span class="font-mono font-bold text-gray-900 dark:text-white flex-shrink-0 w-6 text-right">@roll.Result</span>
                                                            <Badge Color="@GetRollOutcomeBadgeColor(roll.Outcome)" Size="BadgeSize.ExtraSmall" class="flex-shrink-0">
                                                                @GetRollOutcomeShort(roll.Outcome)
                                                            </Badge>
                                                            <span class="text-xs text-gray-400 dark:text-gray-500 flex-shrink-0 w-8 text-right">@GetTimeAgoShort(roll.Timestamp)</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="flex flex-col items-center justify-center text-center py-6">
                                                    <svg class="w-10 h-10 text-gray-300 dark:text-gray-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                                    </svg>
                                                    <p class="text-sm text-gray-500 dark:text-gray-400">
                                                        No dice rolls recorded yet
                                                    </p>
                                                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                                        Rolls will appear here when the AI requests ability checks
                                                    </p>
                                            </div>
                                            }
                                        </div>
                                    </Card>
                    </div>
                    
                    <!-- Column 3 - Combat Tracker, Party (scrollable) -->
                    <div class="h-[calc(100vh-200px)] overflow-auto space-y-4">
                        <!-- Combat Tracker -->
                        <CombatTracker 
                            CampaignId="@CampaignId"
                            Combat="@_combatState"
                            CombatChanged="@HandleCombatChanged"
                            IsDm="true"
                            PartyCharacters="@(campaign?.PartyState ?? [])" />
                        
                        <!-- Party Panel -->
                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                            <div class="p-4">
                                <CharacterList 
                                    Characters="@(campaign!.PartyState)"
                                    OnAddClick="@OpenAddCharacterModal"
                                    OnEdit="@OpenEditCharacterModal"
                                    OnRemove="@HandleRemoveCharacter"
                                    OnUnclaim="@HandleUnclaimCharacter"
                                    ShowInviteButton="true"
                                    OnInviteClick="@OpenInviteModal" />
                            </div>
                        </Card>
                    </div>
                    
                    <!-- Column 4 - Tabbed Panel (Info, Game Log, App Events) -->
                    <div class="h-[calc(100vh-200px)]">
                        <Tabs Class="w-full h-full">
                            <TabListContent>
                                <Tab Index="0">Info</Tab>
                                <Tab Index="1">Game Log</Tab>
                                <Tab Index="2">App Events</Tab>
                            </TabListContent>
                            <TabPanelsContent>
                                <TabPanel Index="0">
                                    <div class="space-y-4 p-1 h-[calc(100vh-280px)] overflow-auto">
                                        <!-- Active Quests -->
                                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                                            <div class="p-4">
                                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                                    <ClipboardIcon Class="inline-block w-4 h-4 mr-2" />
                                                    Active Quests (@(campaign!.ActiveQuests.Count))
                                                </h3>
                                                @if (campaign.ActiveQuests.Any())
                                                {
                                                    <ul class="space-y-2">
                                                        @foreach (var quest in campaign.ActiveQuests)
                                                        {
                                                            <li class="p-2 bg-gray-50 dark:bg-gray-800 rounded">
                                                                <p class="font-medium text-gray-900 dark:text-white text-sm">@quest.Title</p>
                                                                <p class="text-xs text-gray-500 dark:text-gray-400">@quest.State</p>
                                                            </li>
                                                        }
                                                    </ul>
                                                }
                                                else
                                                {
                                                    <p class="text-sm text-gray-500 dark:text-gray-400">No active quests.</p>
                                                }
                                            </div>
                                        </Card>
                                        
                                        <!-- Campaign Info -->
                                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                                            <div class="p-4">
                                                <h3 class="font-bold text-gray-900 dark:text-white mb-3">
                                                    <InfoCircleIcon Class="inline-block w-4 h-4 mr-2" />
                                                    Campaign Info
                                                </h3>
                                                <dl class="space-y-2 text-sm">
                                                    <div class="flex justify-between">
                                                        <dt class="text-gray-500 dark:text-gray-400">Created</dt>
                                                        <dd class="text-gray-900 dark:text-white">@campaign!.CreatedAt.ToString("MMM d, yyyy")</dd>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <dt class="text-gray-500 dark:text-gray-400">Last Activity</dt>
                                                        <dd class="text-gray-900 dark:text-white">@GetTimeAgo(campaign!.LastActivityAt)</dd>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <dt class="text-gray-500 dark:text-gray-400">Milestones</dt>
                                                        <dd class="text-gray-900 dark:text-white">@campaign!.CompletedMilestones.Count completed</dd>
                                                    </div>
                                                </dl>
                                            </div>
                                        </Card>
                                    </div>
                                </TabPanel>
                                
                                <TabPanel Index="1">
                                    <div class="p-1 h-[calc(100vh-280px)] overflow-auto">
                                        <Card Size="CardSize.ExtraLarge" class="max-w-none">
                                            <div class="p-4">
                                                <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2 mb-3">
                                                    <BookOpenIcon Class="mt-1 w-4 h-4" />
                                                    Story Events
                                                    <Badge Color="BadgeColor.Gray" Size="BadgeSize.ExtraSmall">@(campaign!.NarrativeLog?.Count ?? 0)</Badge>
                                                </h3>
                                                @if (campaign?.NarrativeLog?.Any() == true)
                                                {
                                                    <div class="space-y-3">
                                                        @foreach (var entry in campaign.NarrativeLog!.OrderByDescending(e => e.Timestamp))
                                                        {
                                                            <div class="@GetNarrativeEntryClass(entry.Importance)">
                                                                <div class="flex items-center gap-2 mb-1">
                                                                    <Badge Color="@GetImportanceBadgeColor(entry.Importance)" Size="BadgeSize.ExtraSmall">
                                                                        @entry.Importance
                                                                    </Badge>
                                                                    <span class="text-xs text-gray-400 dark:text-gray-500">
                                                                        @GetTimeAgo(entry.Timestamp)
                                                                    </span>
                                                                </div>
                                                                <p class="text-sm text-gray-700 dark:text-gray-300">
                                                                    @entry.Entry
                                                                </p>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-8">
                                                        <BookOpenIcon Class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-600 mb-3" />
                                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                                            No narrative events recorded yet.
                                                        </p>
                                                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">
                                                            Story events will appear here as the adventure progresses.
                                                        </p>
                                                    </div>
                                                }
                                            </div>
                                        </Card>
                                    </div>
                                </TabPanel>
                                
                                <TabPanel Index="2">
                                    <div class="p-1 h-[calc(100vh-280px)] overflow-auto">
                                        <AppEventLog Expanded="true" Class="h-full" />
                                    </div>
                                </TabPanel>
                            </TabPanelsContent>
                        </Tabs>
                    </div>
                </div>
            </div>
            
            <!-- Character Form Modal -->
            <CharacterFormModal 
                @bind-Show="_showCharacterModal"
                EditingCharacter="@_editingCharacter"
                OnSave="@HandleSaveCharacter" />
            
            <!-- Invite Link Modal -->
            <InviteLinkModal 
                @bind-Show="_showInviteModal"
                Campaign="@campaign"
                OnInviteCodeRegenerated="@HandleInviteCodeRegenerated" />
        }
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    private const int MaxRecentRolls = 50;
    
    [Parameter]
    public Guid CampaignId { get; set; }
    
    private CampaignInstance? campaign;
    private bool isLoading = true;
    private string? currentUserId;
    
    // Character management state
    private bool _showCharacterModal;
    private Character? _editingCharacter;
    
    // Invite modal state
    private bool _showInviteModal;
    
    // Combat state
    private CombatStatePayload? _combatState;
    
    // SignalR connection for player events
    private HubConnection? _hubConnection;
    
    // Player choices submitted (from players)
    private List<PlayerChoicePayload> _playerChoicesSubmitted = [];

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to campaign state changes for real-time updates
        GameStateService.OnCampaignChanged += HandleCampaignChanged;
        
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            await LoadCampaignAsync();
        }
        
        isLoading = false;
    }

    private void HandleCampaignChanged(CampaignChangedEventArgs args)
    {
        // Only process changes for the current campaign
        if (campaign == null || args.CampaignId != CampaignId) return;
        
        InvokeAsync(() =>
        {
            switch (args.ChangedProperty)
            {
                case "CurrentReadAloudText":
                    campaign.CurrentReadAloudText = args.NewValue as string ?? "";
                    break;
                case "CurrentReadAloudTone":
                    campaign.CurrentReadAloudTone = args.NewValue as string;
                    break;
                case "CurrentReadAloudPacing":
                    campaign.CurrentReadAloudPacing = args.NewValue as string;
                    break;
                case "ActivePlayerChoices":
                    if (args.NewValue is List<string> choices)
                    {
                        campaign.ActivePlayerChoices = choices;
                        // Clear submitted choices when new choices are presented
                        _playerChoicesSubmitted.Clear();
                    }
                    break;
                case "CurrentSceneImageUri":
                    campaign.CurrentSceneImageUri = args.NewValue as string;
                    break;
                case "RecentRolls":
                    // New roll added - insert at front of list (only if not already present)
                    if (args.NewValue is RollResult newRoll)
                    {
                        var rolls = campaign.RecentRolls;
                    // Dedupe: only add if not already in list (by Id)
                        if (!rolls.Any(r => r.Id == newRoll.Id))
                        {
                            rolls.Insert(0, newRoll);
                            if (rolls.Count > MaxRecentRolls)
                            {
                                rolls = rolls.Take(MaxRecentRolls).ToList();
                            }
                            campaign.RecentRolls = rolls;
                        }
                    }
                    break;
            }
            StateHasChanged();
        });
    }

    public async ValueTask DisposeAsync()
    {
        GameStateService.OnCampaignChanged -= HandleCampaignChanged;
        if (_hubConnection != null)
        {
            try
            {
                await _hubConnection.SendAsync("LeaveCampaign", CampaignId);
            }
            catch { /* Ignore errors during cleanup */ }
            await _hubConnection.DisposeAsync();
        }
    }

    private async Task LoadCampaignAsync()
    {
        campaign = await CampaignService.GetCampaignAsync(CampaignId);
        
        // Verify user owns this campaign
        if (campaign != null && campaign.DmUserId != currentUserId)
        {
            campaign = null; // Don't show campaigns user doesn't own
            return;
        }
        
        // Load combat state from database (ensures correct state after refresh)
        if (campaign != null)
        {
            _combatState = await CombatService.GetCombatStateAsync(CampaignId);
            
            // Setup SignalR connection for real-time player events
            await SetupSignalRAsync();
        }
    }
    
    private async Task SetupSignalRAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();
        
        // Receive player choice submissions
        _hubConnection.On<PlayerChoicePayload>(GameHubEvents.PlayerChoiceSubmitted, async payload =>
        {
            // Add to list (remove old choices from same character)
            _playerChoicesSubmitted.RemoveAll(c => c.CharacterId == payload.CharacterId);
            _playerChoicesSubmitted.Add(payload);
            await InvokeAsync(StateHasChanged);
        });
        
        // Receive character state updates (HP changes, conditions, etc.)
        _hubConnection.On<CharacterStatePayload>(GameHubEvents.CharacterStateUpdated, async payload =>
        {
            if (campaign == null) return;
            
            // Update the character in party state
            var partyState = campaign.PartyState;
            var character = partyState.FirstOrDefault(c => c.Id == payload.CharacterId);
            
            if (character != null)
            {
                switch (payload.Key)
                {
                    case "current_hp":
                        if (int.TryParse(payload.Value?.ToString(), out var newHp))
                        {
                            character.CurrentHp = newHp;
                        }
                        break;
                    case "conditions":
                        // Value is a JSON array string
                        try
                        {
                            var conditions = System.Text.Json.JsonSerializer.Deserialize<List<string>>(payload.Value?.ToString() ?? "[]");
                            if (conditions != null) character.Conditions = conditions;
                        }
                        catch { /* Ignore parse errors */ }
                        break;
                    case "status_notes":
                        character.StatusNotes = payload.Value?.ToString();
                        break;
                    case "initiative":
                        if (int.TryParse(payload.Value?.ToString(), out var newInit))
                        {
                            character.Initiative = newInit;
                        }
                        break;
                }
                
                campaign.PartyState = partyState;
                await InvokeAsync(StateHasChanged);
            }
        });
        
        await _hubConnection.StartAsync();
        
        // Join campaign as DM
        await _hubConnection.SendAsync("JoinCampaign", CampaignId, currentUserId, null, true);
    }

    private string GetLocationDisplay()
    {
        if (campaign == null) return "";
        
        return campaign.CurrentLocationId.Replace("_", " ").ToUpperInvariant() switch
        {
            var x when x.Contains("GOBLIN") => "Goblin Ambush",
            var x when x.Contains("PHANDALIN") => "Phandalin",
            var x when x.Contains("CRAGMAW") => "Cragmaw Hideout",
            var x when x.Contains("REDBRAND") => "Redbrand Hideout",
            _ => campaign.CurrentLocationId.Replace("_", " ")
        };
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        return timeSpan switch
        {
            { TotalMinutes: < 1 } => "Just now",
            { TotalMinutes: < 60 } => $"{(int)timeSpan.TotalMinutes}m ago",
            { TotalHours: < 24 } => $"{(int)timeSpan.TotalHours}h ago",
            { TotalDays: < 7 } => $"{(int)timeSpan.TotalDays}d ago",
            { TotalDays: < 30 } => $"{(int)(timeSpan.TotalDays / 7)}w ago",
            _ => dateTime.ToString("MMM d, yyyy")
        };
    }
    
    // Character Management Methods
    private void OpenAddCharacterModal()
    {
        _editingCharacter = null;
        _showCharacterModal = true;
    }
    
    private void OpenEditCharacterModal(Character character)
    {
        _editingCharacter = character;
        _showCharacterModal = true;
    }
    
    private async Task HandleSaveCharacter(Character character)
    {
        if (campaign == null) return;
        
        // Get the current party list (deserialized from JSON)
        var party = campaign.PartyState;
        
        if (_editingCharacter == null)
        {
            // Add new character
            party.Add(character);
        }
        else
        {
            // Update existing character in the list
            var index = party.FindIndex(c => c.Id == character.Id);
            if (index >= 0)
            {
                party[index] = character;
            }
        }
        
        // Set back to serialize to JSON
        campaign.PartyState = party;
        
        // Save to database
        await CampaignService.UpdateCampaignAsync(campaign);
        StateHasChanged();
    }
    
    private async Task HandleRemoveCharacter(Character character)
    {
        if (campaign == null) return;
        
        // Get the current party list (deserialized from JSON)
        var party = campaign.PartyState;
        party.RemoveAll(c => c.Id == character.Id);
        
        // Set back to serialize to JSON
        campaign.PartyState = party;
        
        await CampaignService.UpdateCampaignAsync(campaign);
        StateHasChanged();
    }
    
    // Invite Modal Methods
    private void OpenInviteModal()
    {
        _showInviteModal = true;
    }
    
    private void HandleInviteCodeRegenerated(string newCode)
    {
        // Campaign object is already updated by the modal
        StateHasChanged();
    }
    
    private void HandleCombatChanged(CombatStatePayload? payload)
    {
        _combatState = payload;
        StateHasChanged();
    }
    
    private async Task HandleUnclaimCharacter(Character character)
    {
        if (campaign == null) return;
        
        var success = await CharacterService.UnclaimCharacterAsync(campaign.Id, character.Id);
        if (success)
        {
            // Reload campaign to get fresh party state
            await LoadCampaignAsync();
            StateHasChanged();
        }
    }
    
    // Narrative Log Styling Methods
    private string GetNarrativeEntryClass(string importance) => importance.ToLower() switch
    {
        "critical" => "p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800",
        "minor" => "p-2 rounded-lg bg-gray-50 dark:bg-gray-800/30",
        _ => "p-3 rounded-lg bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700"
    };
    
    private BadgeColor GetImportanceBadgeColor(string importance) => importance.ToLower() switch
    {
        "critical" => BadgeColor.Purple,
        "minor" => BadgeColor.Gray,
        _ => BadgeColor.Info
    };
    
    // Roll Display Helper Methods
    private BadgeColor GetRollOutcomeBadgeColor(string outcome) => outcome.ToLower() switch
    {
        "critical success" => BadgeColor.Purple,
        "success" => BadgeColor.Success,
        "failure" => BadgeColor.Warning,
        "critical failure" => BadgeColor.Pink,
        _ => BadgeColor.Gray
    };
    
    private string GetRollOutcomeDisplay(string outcome) => outcome.ToLower() switch
    {
        "critical success" => "‚ú® Crit!",
        "success" => "‚úì Pass",
        "failure" => "‚úó Fail",
        "critical failure" => "üíÄ Crit Fail",
        _ => outcome
    };
    
    private string GetRollOutcomeShort(string outcome) => outcome.ToLower() switch
    {
        "critical success" => "‚ú®",
        "success" => "‚úì",
        "failure" => "‚úó",
        "critical failure" => "üíÄ",
        _ => "?"
    };
    
    private string GetTimeAgoShort(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        
        return timeSpan switch
        {
            { TotalMinutes: < 1 } => "now",
            { TotalMinutes: < 60 } => $"{(int)timeSpan.TotalMinutes}m",
            { TotalHours: < 24 } => $"{(int)timeSpan.TotalHours}h",
            { TotalDays: < 7 } => $"{(int)timeSpan.TotalDays}d",
            _ => $"{(int)(timeSpan.TotalDays / 7)}w"
        };
    }
    
    // Tone/Pacing Badge Helper Methods
    private BadgeColor GetToneBadgeColor(string tone) => tone.ToLower() switch
    {
        "ominous" or "dark" or "sinister" => BadgeColor.Gray,  // Dark tone ‚Üí Gray (darker visual)
        "tense" or "urgent" or "dramatic" => BadgeColor.Pink,
        "mysterious" or "eerie" or "suspenseful" => BadgeColor.Purple,
        "cheerful" or "joyful" or "celebratory" => BadgeColor.Success,
        "sad" or "somber" or "melancholic" => BadgeColor.Info,
        "humorous" or "comedic" or "lighthearted" => BadgeColor.Warning,
        "epic" or "heroic" or "triumphant" => BadgeColor.Primary,
        _ => BadgeColor.Gray
    };
    
    private BadgeColor GetPacingBadgeColor(string pacing) => pacing.ToLower() switch
    {
        "slow" or "deliberate" or "measured" => BadgeColor.Info,
        "fast" or "rapid" or "urgent" => BadgeColor.Pink,
        "building" or "escalating" => BadgeColor.Warning,
        _ => BadgeColor.Gray  // "normal", "steady", or unknown
    };
    
    // Player Choice Aggregation Helper Methods
    
    /// <summary>
    /// Gets the total number of player characters (PCs) who can respond to choices.
    /// </summary>
    private int GetTotalPlayersCount()
    {
        return campaign?.PartyState.Count(c => c.Type == "PC") ?? 0;
    }
    
    /// <summary>
    /// Gets the count of unique players who have submitted a choice.
    /// </summary>
    private int GetRespondedCount()
    {
        return _playerChoicesSubmitted.Count;
    }
    
    /// <summary>
    /// Gets all player choice submissions for a specific choice option.
    /// </summary>
    private List<PlayerChoicePayload> GetPlayersWhoChose(string choice)
    {
        return _playerChoicesSubmitted
            .Where(p => string.Equals(p.Choice, choice, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }
    
    /// <summary>
    /// Gets the list of PC characters who have NOT yet submitted a choice.
    /// </summary>
    private List<Character> GetWaitingPlayers()
    {
        if (campaign == null) return [];
        
        var respondedCharacterIds = _playerChoicesSubmitted
            .Select(p => p.CharacterId)
            .ToHashSet();
        
        return campaign.PartyState
            .Where(c => c.Type == "PC" && !respondedCharacterIds.Contains(c.Id.ToString()))
            .ToList();
    }
}

@page "/sessions/new"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Riddle.Web.Services
@inject ISessionService SessionService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<PageTitle>New Session - Riddle</PageTitle>

<AuthorizeView>
    <Authorized>
        <div class="max-w-2xl mx-auto mt-8">
            <Card Size="CardSize.ExtraLarge" class="max-w-none">
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                        Create New Session
                    </h2>
                    
                    <EditForm Model="@model" OnValidSubmit="@HandleSubmit" FormName="new-session" Context="editContext">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-6">
                            <Label For="campaignName" Value="Campaign Name" class="mb-2 block" />
                            <TextInput Id="campaignName" 
                                       @bind-Value="model.CampaignName" 
                                       Placeholder="e.g., Lost Mine of Phandelver"
                                       class="w-full" />
                            <ValidationMessage For="@(() => model.CampaignName)" class="text-red-500 text-sm mt-1" />
                        </div>
                        
                        <div class="mb-6">
                            <Label Value="Select Campaign Module" class="mb-2 block" />
                            <div class="grid gap-3 sm:grid-cols-2">
                                <div class="@GetModuleCardClass("lost_mine")" @onclick="@(() => SelectModule("lost_mine"))">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-primary-100 dark:bg-primary-900">
                                            <BookOpenIcon Class="w-5 h-5 text-primary-600 dark:text-primary-400" />
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900 dark:text-white">Lost Mine of Phandelver</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Starter Set Adventure</p>
                                        </div>
                                    </div>
                                    @if (model.ModuleId == "lost_mine")
                                    {
                                        <CheckCircleIcon Class="w-5 h-5 text-primary-600 dark:text-primary-400 absolute top-2 right-2" />
                                    }
                                </div>
                                
                                <div class="@GetModuleCardClass("homebrew")" @onclick="@(() => SelectModule("homebrew"))">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center justify-center w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900">
                                            <PencilIcon Class="w-5 h-5 text-purple-600 dark:text-purple-400" />
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900 dark:text-white">Homebrew Campaign</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Create your own adventure</p>
                                        </div>
                                    </div>
                                    @if (model.ModuleId == "homebrew")
                                    {
                                        <CheckCircleIcon Class="w-5 h-5 text-purple-600 dark:text-purple-400 absolute top-2 right-2" />
                                    }
                                </div>
                            </div>
                        </div>
                        
                        @if (errorMessage != null)
                        {
                            <Alert Color="AlertColor.Failure" class="mb-4">
                                @errorMessage
                            </Alert>
                        }
                        
                        <div class="flex gap-4 pt-4">
                            <Button Type="submit" Color="ButtonColor.Primary" Disabled="@isSubmitting" class="flex-1">
                                @if (isSubmitting)
                                {
                                    <Spinner Size="SpinnerSize.Sm" class="mr-2" />
                                    <span>Creating...</span>
                                }
                                else
                                {
                                    <PlusIcon Class="mr-2 h-5 w-5" />
                                    <span>Create Session</span>
                                }
                            </Button>
                            <Button Href="/" Color="ButtonColor.Light" class="flex-1">
                                Cancel
                            </Button>
                        </div>
                    </EditForm>
                </div>
            </Card>
        </div>
    </Authorized>
    <NotAuthorized>
        <RedirectToLogin />
    </NotAuthorized>
</AuthorizeView>

@code {
    private NewSessionModel model = new();
    private bool isSubmitting = false;
    private string? errorMessage;
    private string? currentUserId;

    public class NewSessionModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Campaign name is required")]
        [System.ComponentModel.DataAnnotations.StringLength(200, MinimumLength = 3, ErrorMessage = "Campaign name must be between 3 and 200 characters")]
        public string CampaignName { get; set; } = "Lost Mine of Phandelver";
        
        public string ModuleId { get; set; } = "lost_mine";
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        }
    }

    private void SelectModule(string moduleId)
    {
        model.ModuleId = moduleId;
        
        // Auto-set campaign name based on module
        model.CampaignName = moduleId switch
        {
            "lost_mine" => "Lost Mine of Phandelver",
            "homebrew" => "My Homebrew Campaign",
            _ => model.CampaignName
        };
    }

    private string GetModuleCardClass(string moduleId)
    {
        var baseClass = "relative p-4 rounded-lg border-2 cursor-pointer transition-colors ";
        
        if (model.ModuleId == moduleId)
        {
            return baseClass + "border-primary-500 bg-primary-50 dark:bg-primary-900/20";
        }
        
        return baseClass + "border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600";
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrEmpty(currentUserId))
        {
            errorMessage = "You must be logged in to create a session.";
            return;
        }
        
        isSubmitting = true;
        errorMessage = null;
        
        try
        {
            var session = await SessionService.CreateSessionAsync(currentUserId, model.CampaignName);
            Navigation.NavigateTo($"/dm/{session.Id}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to create session: {ex.Message}";
            isSubmitting = false;
        }
    }
}

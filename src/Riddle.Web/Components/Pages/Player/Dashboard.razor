@page "/play/{CampaignId:guid}"
@layout StackedLayout
@attribute [Authorize]
@rendermode InteractiveServer

@using Riddle.Web.Models
@using Riddle.Web.Services
@using Riddle.Web.Components.Player
@using Riddle.Web.Components.Combat
@using Riddle.Web.Hubs
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@using System.Security.Claims

@implements IAsyncDisposable

@inject ICampaignService CampaignService
@inject ICombatService CombatService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>@(campaign?.Name ?? "Player Dashboard") - Riddle</PageTitle>

<div class="min-h-screen">
    @if (isLoading)
    {
        <div class="flex items-center justify-center min-h-[60vh]">
            <div class="text-center">
                <Spinner Size="SpinnerSize.Xl" Color="SpinnerColor.Purple" />
                <Paragraph class="!text-gray-400 mt-4">Loading your adventure...</Paragraph>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="flex items-center justify-center min-h-[60vh] px-4">
            <Card class="max-w-md bg-gray-800 border-gray-700">
                <div class="text-center">
                    <span class="text-4xl mb-4 block">‚ùå</span>
                    <Heading Tag="HeadingTag.H2" Size="TextSize.XL" class="mb-2">Error</Heading>
                    <Paragraph class="!text-gray-400 mb-4">@errorMessage</Paragraph>
                    <Button Color="ButtonColor.Primary" @onclick="GoHome">
                        Return Home
                    </Button>
                </div>
            </Card>
        </div>
    }
    else if (selectedCharacter == null)
    {
        @* Character Selection Screen *@
        <div class="flex items-center justify-center min-h-[60vh] px-4">
            <div class="w-full max-w-lg">
                <Card class="p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                    <div class="flex flex-col space-y-6">
                        <div class="flex flex-col space-y-2 text-center">
                            <Heading Tag="HeadingTag.H1" Size="TextSize.XXL">@campaign?.Name</Heading>
                            <Paragraph class="!text-gray-400">@campaign?.CampaignModule</Paragraph>
                        </div>
                    
                    @if (playerCharacters.Count == 0)
                    {
                        <div class="text-center py-8">
                            <span class="text-4xl mb-4 block">üé≠</span>
                            <Heading Tag="HeadingTag.H2" Size="TextSize.XL" class="mb-2">No Characters Assigned</Heading>
                            <Paragraph class="!text-gray-400 mb-2">You don't have any characters in this campaign yet.</Paragraph>
                                <Paragraph Size="TextSize.SM" class="!text-gray-500">Ask your DM to assign you a character.</Paragraph>
                            </div>
                        }
                        else if (playerCharacters.Count == 1)
                        {
                            @* Auto-select single character *@
                            <div class="flex flex-col space-y-4 text-center py-4">
                                <Spinner Size="SpinnerSize.Md" Color="SpinnerColor.Purple" />
                                <Paragraph class="!text-gray-400">Loading your character...</Paragraph>
                            </div>
                        }
                        else
                        {
                            <Heading Tag="HeadingTag.H2" Size="TextSize.LG">Select Your Character</Heading>
                            <div class="space-y-2">
                            @foreach (var character in playerCharacters)
                            {
                                <button class="w-full p-3 bg-gray-700/50 hover:bg-gray-700 rounded-lg transition-colors text-left flex items-center gap-3 border border-gray-600 hover:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                        @onclick="() => SelectCharacter(character)">
                                    <Avatar Size="AvatarSize.Medium" 
                                            Rounded="true" 
                                            class="!bg-gradient-to-br !from-purple-500 !to-indigo-600 flex-shrink-0">
                                        <span class="text-lg">@GetClassIcon(character.Class)</span>
                                    </Avatar>
                                    <div class="flex-1 min-w-0">
                                    <Span Weight="FontWeight.SemiBold" CustomColor="text-white" class="block truncate">@character.Name</Span>
                                        <Span Size="TextSize.SM" CustomColor="text-gray-400">@character.DisplayRaceClass ‚Ä¢ Level @character.Level</Span>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <Badge Color="@GetHpBadgeColor(character)">
                                            @character.CurrentHp/@character.MaxHp HP
                                        </Badge>
                                    </div>
                                </button>
                            }
                            </div>
                        }
                    </div>
                </Card>
            </div>
        </div>
    }
    else
    {
        @* Main Dashboard View *@
        <div class="px-4 py-4 lg:px-6">
            
            
            @* Compact Header with Connection Status *@
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                <div>
                    <Heading Tag="HeadingTag.H1" Size="TextSize.XL" class="!mb-0">@campaign?.Name</Heading>
                    <Paragraph Size="TextSize.SM" class="!text-gray-400 !mt-0">
                        @campaign?.CampaignModule ‚Ä¢ Playing as <Span Weight="FontWeight.Medium" CustomColor="text-purple-400">@selectedCharacter?.Name</Span>
                    </Paragraph>
                </div>
                <div class="flex items-center gap-2">
                    <Badge Color="BadgeColor.Success" class="flex items-center gap-1.5">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Connected
                    </Badge>
                    @if (playerCharacters.Count > 1)
                    {
                        <Button Color="ButtonColor.Light" Size="ButtonSize.Small" 
                                @onclick="ClearCharacterSelection">
                            <RefreshIcon class="w-4 h-4 mr-1" />
                            Switch
                        </Button>
                    }
                </div>
            </div>

            @* Narrative Anchor Banner - Persistent mood indicator *@
            @if (_narrativeAnchor != null)
            {
                <div class="mb-4 p-3 rounded-lg border-2 @GetNarrativeAnchorClass(_narrativeAnchor.MoodCategory) transition-all duration-500">
                    <div class="flex items-center gap-2">
                        <span class="text-lg">@GetNarrativeAnchorIcon(_narrativeAnchor.MoodCategory)</span>
                        <span class="font-medium text-sm italic">@_narrativeAnchor.ShortText</span>
                    </div>
                </div>
            }
            
            @* Group Insight Flash - Temporary discovery notification *@
            @if (_groupInsight != null)
            {
                <div class="mb-4 p-4 rounded-lg border-2 border-yellow-500 bg-yellow-900/30 @(_groupInsight.HighlightEffect ? "animate-pulse" : "") transition-all duration-300">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">üí°</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <Badge Color="BadgeColor.Warning" Size="BadgeSize.ExtraSmall">@_groupInsight.RelevantSkill</Badge>
                                <span class="text-xs text-yellow-400">Party Insight</span>
                            </div>
                            <p class="text-yellow-100 font-medium">@_groupInsight.Text</p>
                        </div>
                    </div>
                </div>
            }
            
            @* Main Content Grid - 3 columns on xl, 2 on lg, 1 on mobile *@
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                @* Left Column: Game State Panels *@
                @* lg: 7/12, xl: 5/12 *@
                <div class="lg:col-span-7 xl:col-span-5 space-y-4 order-1">
                    @* Atmosphere Pulse - Fleeting sensory text *@
                    @if (_atmospherePulse != null)
                    {
                        <div class="p-3 rounded-lg border @GetAtmosphereIntensityClass(_atmospherePulse.Intensity) transition-all duration-500">
                            <div class="flex items-center gap-2">
                                <span class="text-lg flex-shrink-0">@GetAtmosphereIcon(_atmospherePulse.SensoryType)</span>
                                <p class="text-gray-200 italic text-sm">@_atmospherePulse.Text</p>
                            </div>
                        </div>
                    }
                    
                    @* Active Player Choices *@
                    @if (campaign?.ActivePlayerChoices.Any() == true)
                    {
                        <Card Size="CardSize.ExtraLarge" class="!max-w-none bg-gray-800 border-gray-700">
                            <div class="p-4">
                                <div class="flex items-center justify-between pb-3 border-b border-gray-200 dark:border-gray-700 mb-3">
                                    <h3 class="font-bold text-gray-900 dark:text-white flex items-center gap-2">
                                        <CheckCircleIcon Class="w-4 h-4" />
                                        Player Choices
                                        <Badge Color="BadgeColor.Gray" Size="BadgeSize.ExtraSmall">@campaign.ActivePlayerChoices.Count</Badge>
                                    </h3>
                                </div>
                                <div class="grid grid-cols-1 gap-2">
                                    @foreach (var choice in campaign.ActivePlayerChoices)
                                    {
                                        var isSelected = string.Equals(selectedChoice, choice, StringComparison.OrdinalIgnoreCase);
                                        <Button Color="@(isSelected ? ButtonColor.Green : ButtonColor.Primary)" 
                                                class="w-full justify-center"
                                                Outline="@(!isSelected && hasSelectedChoice)"
                                                @onclick="() => SelectChoice(choice)">
                                            @if (isSelected)
                                            {
                                                <span>‚úì @choice</span>
                                            }
                                            else
                                            {
                                                @choice
                                            }
                                        </Button>
                                    }
                                </div>
                                @if (hasSelectedChoice)
                                {
                                    <div class="mt-3 text-center">
                                        <p class="text-sm text-gray-400 mt-1">
                                            <span class="text-green-400">‚úì Choice submitted</span> ‚Ä¢ Click another option to change
                                        </p>
                                    </div>
                                }
                            </div>
                        </Card>
                    }
                    else if (!string.IsNullOrEmpty(campaign?.CurrentReadAloudText) || !string.IsNullOrEmpty(campaign?.CurrentSceneImageUri))
                    {
                        @* Waiting state when no choices *@
                        <Card Size="CardSize.ExtraLarge" class="!max-w-none bg-gray-800 border-gray-700">
                            <div class="p-4 text-center">
                                <Spinner Size="SpinnerSize.Sm" Color="SpinnerColor.Purple" class="mb-2" />
                                <p class="text-gray-400">Waiting for the DM...</p>
                            </div>
                        </Card>
                    }
                    
                    @* Your Dice Rolls *@
                    @{
                        var myRolls = campaign?.RecentRolls?.Where(r => 
                            string.Equals(r.CharacterName, selectedCharacter?.Name, StringComparison.OrdinalIgnoreCase)).ToList() ?? [];
                    }
                    @if (myRolls.Any())
                    {
                        <Card Size="CardSize.ExtraLarge" class="!max-w-none bg-gray-800 border-gray-700">
                            <div class="p-4">
                                <div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-700">
                                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                    </svg>
                                    <h3 class="font-bold text-gray-900 dark:text-white">Your Dice Rolls</h3>
                                    <Badge Color="BadgeColor.Gray" Size="BadgeSize.ExtraSmall">@myRolls.Count</Badge>
                                </div>
                                <div class="max-h-48 overflow-y-auto">
                                    @foreach (var roll in myRolls.Take(MaxRecentRolls))
                                    {
                                        <div class="flex items-center gap-2 py-1.5 px-2 rounded hover:bg-gray-700/50 text-sm">
                                            <span class="text-gray-400 truncate flex-1" title="@roll.CheckType">@roll.CheckType</span>
                                            <span class="font-mono font-bold text-white flex-shrink-0 w-6 text-right">@roll.Result</span>
                                            <Badge Color="@GetRollOutcomeBadgeColor(roll.Outcome)" Size="BadgeSize.ExtraSmall" class="flex-shrink-0">
                                                @GetRollOutcomeShort(roll.Outcome)
                                            </Badge>
                                            <span class="text-xs text-gray-500 flex-shrink-0 w-8 text-right">@GetTimeAgoShort(roll.Timestamp)</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </Card>
                    }
                </div>
                
                @* Middle Column: Combat Tracker + Party Members *@
                @* xl: 4/12, lg: full width on smaller screens *@
                <div class="xl:col-span-4 lg:col-span-7 xl:order-2 order-3 lg:order-1 space-y-4">
                    <div class="xl:sticky xl:top-4 space-y-4">
                        @* Combat Tracker - Only when combat is active *@
                        @if (_combatState?.IsActive == true)
                        {
                            <CombatTracker 
                                CampaignId="CampaignId"
                                Combat="_combatState"
                                IsDm="false"
                                CombatChanged="OnCombatStateChanged" />
                        }
                        
                        @* Party Members Card - Shows other players *@
                        @{
                            var otherPartyMembers = campaign?.PartyState
                                .Where(c => c.Type == "PC" && c.Id != selectedCharacter?.Id)
                                .ToList() ?? [];
                        }
                        @if (otherPartyMembers.Any())
                        {
                            <Card Size="CardSize.ExtraLarge" class="!max-w-none bg-gray-800 border-gray-700">
                                <div class="p-4">
                                    <h3 class="font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                                        <span>üë•</span>
                                        Party Members
                                        <Badge Color="BadgeColor.Gray" Size="BadgeSize.ExtraSmall">@otherPartyMembers.Count</Badge>
                                    </h3>
                                    <div class="space-y-2">
                                        @foreach (var member in otherPartyMembers)
                                        {
                                            <div class="flex items-center gap-3 p-2 rounded-lg bg-gray-700/50">
                                                <Avatar Size="AvatarSize.Small" 
                                                        Rounded="true" 
                                                        class="!bg-gradient-to-br !from-purple-500 !to-indigo-600 flex-shrink-0">
                                                    <span class="text-sm">@GetClassIcon(member.Class)</span>
                                                </Avatar>
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-medium text-white text-sm truncate">@member.Name</div>
                                                    <div class="text-xs text-gray-400">@member.DisplayRaceClass ‚Ä¢ Lvl @member.Level</div>
                                                </div>
                                                <div class="flex flex-col items-end flex-shrink-0">
                                                    <Badge Color="@GetHpBadgeColor(member)" Size="BadgeSize.ExtraSmall">
                                                        @member.CurrentHp/@member.MaxHp
                                                    </Badge>
                                                    <div class="flex gap-1 mt-1">
                                                        <span class="text-xs text-gray-500" title="AC">üõ°Ô∏è@member.ArmorClass</span>
                                                        <span class="text-xs text-gray-500" title="Initiative (DEX)">‚ö°@(member.DexterityModifier >= 0 ? "+" : "")@member.DexterityModifier</span>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </Card>
                        }
                    </div>
                </div>
                
                @* Right Column: Character Card *@
                @* xl: 3/12, lg: 5/12 *@
                <div class="lg:col-span-5 xl:col-span-3 order-2 xl:order-3">
                    <div class="xl:sticky xl:top-4">
                        <PlayerCharacterCard Character="selectedCharacter" />
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private const int MaxRecentRolls = 50;
    private const int AtmospherePulseDurationMs = 10_000;
    private const int GroupInsightDurationMs = 8_000;
    
    [Parameter]
    public Guid CampaignId { get; set; }
    
    private CampaignInstance? campaign;
    private List<Character> playerCharacters = [];
    private Character? selectedCharacter;
    private string? currentUserId;
    private bool isLoading = true;
    private string? errorMessage;
    
    private bool hasSelectedChoice = false;
    private string? selectedChoice;
    
    private CombatStatePayload? _combatState;
    private HubConnection? _hubConnection;
    
    // Atmospheric state
    private AtmospherePulsePayload? _atmospherePulse;
    private NarrativeAnchorPayload? _narrativeAnchor;
    private GroupInsightPayload? _groupInsight;
    private CancellationTokenSource? _atmospherePulseCts;
    private CancellationTokenSource? _groupInsightCts;
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get current user
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated != true)
            {
                Navigation.NavigateTo($"/Account/Login?ReturnUrl=/play/{CampaignId}");
                return;
            }
            
            currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            // Load campaign
            campaign = await CampaignService.GetCampaignAsync(CampaignId);
            if (campaign == null)
            {
                errorMessage = "Campaign not found.";
                return;
            }
            
            // Find characters belonging to this player
            playerCharacters = campaign.PartyState
                .Where(c => c.PlayerId == currentUserId && c.Type == "PC")
                .ToList();
            
            // Auto-select if only one character
            if (playerCharacters.Count == 1)
            {
                selectedCharacter = playerCharacters.First();
            }
            
            // Load current combat state if any
            _combatState = await CombatService.GetCombatStateAsync(CampaignId);
            
            // Setup SignalR connection for real-time updates
            await SetupSignalRAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load campaign: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private void SelectCharacter(Character character)
    {
        selectedCharacter = character;
    }
    
    private async Task SelectChoice(string choice)
    {
        if (selectedCharacter == null || _hubConnection == null) return;
        
        // Mark choice as selected
        hasSelectedChoice = true;
        selectedChoice = choice;
        
        // Send choice to DM via SignalR
        await _hubConnection.SendAsync("SubmitChoice", CampaignId, selectedCharacter.Id.ToString(), selectedCharacter.Name, choice);
    }
    
    private void GoHome() => Navigation.NavigateTo("/");
    
    private void ClearCharacterSelection() => selectedCharacter = null;
    
    private async Task SetupSignalRAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();
        
        // Handle reconnection - reload data from DB to restore state
        _hubConnection.Reconnected += OnReconnectedAsync;
        
        // Combat events
        _hubConnection.On<CombatStatePayload>(GameHubEvents.CombatStarted, async payload =>
        {
            _combatState = payload;
            await InvokeAsync(StateHasChanged);
        });
        
        _hubConnection.On<int, string, int>(GameHubEvents.TurnAdvanced, async (newIndex, currentId, roundNumber) =>
        {
            if (_combatState != null)
            {
                _combatState = _combatState with 
                { 
                    CurrentTurnIndex = newIndex,
                    RoundNumber = roundNumber
                };
                await InvokeAsync(StateHasChanged);
            }
        });
        
        _hubConnection.On(GameHubEvents.CombatEnded, async () =>
        {
            _combatState = null;
            await InvokeAsync(StateHasChanged);
        });
        
        // Player choices received from DM/LLM
        _hubConnection.On<List<string>>(GameHubEvents.PlayerChoicesReceived, async choices =>
        {
            if (campaign != null)
            {
                campaign.ActivePlayerChoices = choices;
                hasSelectedChoice = false;
                selectedChoice = null;
            }
            await InvokeAsync(StateHasChanged);
        });
        
        // Character state updates (HP changes, conditions, etc.)
        _hubConnection.On<CharacterStatePayload>(GameHubEvents.CharacterStateUpdated, async payload =>
        {
            // Refresh campaign to get updated character state
            campaign = await CampaignService.GetCampaignAsync(CampaignId);
            if (campaign != null && selectedCharacter != null)
            {
                // Re-select the character to get updated state
                selectedCharacter = campaign.PartyState.FirstOrDefault(c => c.Id == selectedCharacter.Id);
            }
            await InvokeAsync(StateHasChanged);
        });
        
        // Atmospheric events (Player-only)
        _hubConnection.On<AtmospherePulsePayload>(GameHubEvents.AtmospherePulseReceived, async payload =>
        {
            // Cancel any existing pulse timer
            _atmospherePulseCts?.Cancel();
            _atmospherePulseCts = new CancellationTokenSource();
            
            _atmospherePulse = payload;
            await InvokeAsync(StateHasChanged);
            
            // Auto-dismiss after duration
            _ = DismissAtmospherePulseAfterDelayAsync(_atmospherePulseCts.Token);
        });
        
        _hubConnection.On<NarrativeAnchorPayload>(GameHubEvents.NarrativeAnchorUpdated, payload =>
        {
            // Use synchronous update with new reference to ensure Blazor detects change
            _narrativeAnchor = new NarrativeAnchorPayload(payload.ShortText, payload.MoodCategory);
            InvokeAsync(StateHasChanged);
        });
        
        _hubConnection.On<GroupInsightPayload>(GameHubEvents.GroupInsightTriggered, async payload =>
        {
            // Cancel any existing insight timer
            _groupInsightCts?.Cancel();
            _groupInsightCts = new CancellationTokenSource();
            
            _groupInsight = payload;
            await InvokeAsync(StateHasChanged);
            
            // Auto-dismiss after duration
            _ = DismissGroupInsightAfterDelayAsync(_groupInsightCts.Token);
        });
        
        await _hubConnection.StartAsync();
        
        // Join campaign group for real-time updates
        await _hubConnection.SendAsync("JoinCampaign", CampaignId, currentUserId, selectedCharacter?.Id.ToString(), false);
    }
    
    private async Task OnReconnectedAsync(string? connectionId)
    {
        // Reload campaign from database to restore persisted state (including character claims)
        campaign = await CampaignService.GetCampaignAsync(CampaignId);
        if (campaign != null)
        {
            // Repopulate player characters list from fresh DB data
            playerCharacters = campaign.PartyState
                .Where(c => c.PlayerId == currentUserId && c.Type == "PC")
                .ToList();
            
            // Restore selected character reference from fresh data
            if (selectedCharacter != null)
            {
                selectedCharacter = campaign.PartyState.FirstOrDefault(c => c.Id == selectedCharacter.Id);
            }
            else if (playerCharacters.Count == 1)
            {
                // Auto-select if only one character
                selectedCharacter = playerCharacters.First();
            }
            
            // Reload combat state
            _combatState = await CombatService.GetCombatStateAsync(CampaignId);
            
            // Re-join campaign group after reconnection
            await _hubConnection!.SendAsync("JoinCampaign", CampaignId, currentUserId, selectedCharacter?.Id.ToString(), false);
        }
        
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task OnCombatStateChanged(CombatStatePayload? newState)
    {
        _combatState = newState;
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task DismissAtmospherePulseAfterDelayAsync(CancellationToken ct)
    {
        try
        {
            await Task.Delay(AtmospherePulseDurationMs, ct);
            _atmospherePulse = null;
            await InvokeAsync(StateHasChanged);
        }
        catch (TaskCanceledException) { /* Expected when new pulse arrives */ }
    }
    
    private async Task DismissGroupInsightAfterDelayAsync(CancellationToken ct)
    {
        try
        {
            await Task.Delay(GroupInsightDurationMs, ct);
            _groupInsight = null;
            await InvokeAsync(StateHasChanged);
        }
        catch (TaskCanceledException) { /* Expected when new insight arrives */ }
    }
    
    public async ValueTask DisposeAsync()
    {
        _atmospherePulseCts?.Cancel();
        _groupInsightCts?.Cancel();
        
        if (_hubConnection != null)
        {
            try
            {
                await _hubConnection.SendAsync("LeaveCampaign", CampaignId);
            }
            catch { /* Ignore errors during cleanup */ }
            await _hubConnection.DisposeAsync();
        }
    }
    
    private string GetClassIcon(string? className) => className?.ToLower() switch
    {
        "fighter" => "‚öîÔ∏è",
        "wizard" => "üßô",
        "rogue" => "üó°Ô∏è",
        "cleric" => "‚úùÔ∏è",
        "paladin" => "üõ°Ô∏è",
        "ranger" => "üèπ",
        "barbarian" => "üí™",
        "bard" => "üéµ",
        "druid" => "üåø",
        "monk" => "üëä",
        "sorcerer" => "‚ú®",
        "warlock" => "üëÅÔ∏è",
        _ => "üë§"
    };
    
    private BadgeColor GetHpBadgeColor(Character character)
    {
        if (character.MaxHp <= 0) return BadgeColor.Gray;
        var pct = (double)character.CurrentHp / character.MaxHp * 100;
        return pct switch
        {
            <= 25 => BadgeColor.Pink,
            <= 50 => BadgeColor.Warning,
            _ => BadgeColor.Success
        };
    }
    
    private string FormatLocationName(string? locationId)
    {
        if (string.IsNullOrEmpty(locationId)) return "Unknown Location";
        return string.Join(" ", locationId.Split('_').Select(w => 
            char.ToUpper(w[0]) + w.Substring(1).ToLower()));
    }
    
    private string FormatChapterName(string? chapterId)
    {
        if (string.IsNullOrEmpty(chapterId)) return "";
        return string.Join(" ", chapterId.Split('_').Select(w => 
            char.ToUpper(w[0]) + w.Substring(1).ToLower()));
    }
    
    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        return timeSpan switch
        {
            { TotalMinutes: < 1 } => "Just now",
            { TotalMinutes: < 60 } => $"{(int)timeSpan.TotalMinutes}m ago",
            { TotalHours: < 24 } => $"{(int)timeSpan.TotalHours}h ago",
            _ => dateTime.ToString("MMM d")
        };
    }
    
    private BadgeColor GetRollOutcomeBadgeColor(string outcome) => outcome.ToLower() switch
    {
        "critical success" => BadgeColor.Purple,
        "success" => BadgeColor.Success,
        "failure" => BadgeColor.Warning,
        "critical failure" => BadgeColor.Pink,
        _ => BadgeColor.Gray
    };
    
    private string GetRollOutcomeDisplay(string outcome) => outcome.ToLower() switch
    {
        "critical success" => "‚ú® Crit!",
        "success" => "‚úì Pass",
        "failure" => "‚úó Fail",
        "critical failure" => "üíÄ Crit Fail",
        _ => outcome
    };
    
    private string GetRollOutcomeTextColor(string outcome) => outcome.ToLower() switch
    {
        "critical success" => "text-purple-400",
        "success" => "text-green-400",
        "failure" => "text-yellow-400",
        "critical failure" => "text-red-400",
        _ => "text-gray-400"
    };
    
    private string GetRollOutcomeShort(string outcome) => outcome.ToLower() switch
    {
        "critical success" => "‚ú®",
        "success" => "‚úì",
        "failure" => "‚úó",
        "critical failure" => "üíÄ",
        _ => "?"
    };
    
    private string GetTimeAgoShort(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;
        return timeSpan switch
        {
            { TotalMinutes: < 1 } => "now",
            { TotalMinutes: < 60 } => $"{(int)timeSpan.TotalMinutes}m",
            { TotalHours: < 24 } => $"{(int)timeSpan.TotalHours}h",
            { TotalDays: < 7 } => $"{(int)timeSpan.TotalDays}d",
            _ => $"{(int)(timeSpan.TotalDays / 7)}w"
        };
    }
    
    private string GetAtmosphereIcon(string? sensoryType) => sensoryType?.ToLower() switch
    {
        "sound" => "üîä",
        "smell" => "üëÉ",
        "visual" => "üëÅÔ∏è",
        "feeling" => "üí´",
        _ => "‚ú®"
    };
    
    private string GetAtmosphereIntensityClass(string? intensity) => intensity?.ToLower() switch
    {
        "high" => "animate-pulse border-red-500/50 bg-red-900/20",
        "medium" => "border-amber-500/50 bg-amber-900/20",
        _ => "border-purple-500/50 bg-purple-900/20"
    };
    
    private string GetNarrativeAnchorClass(string? moodCategory) => moodCategory?.ToLower() switch
    {
        "danger" => "border-red-500 bg-red-900/30 text-red-200",
        "mystery" => "border-purple-500 bg-purple-900/30 text-purple-200",
        "safety" => "border-green-500 bg-green-900/30 text-green-200",
        "urgency" => "border-amber-500 bg-amber-900/30 text-amber-200",
        _ => "border-gray-500 bg-gray-900/30 text-gray-200"
    };
    
    private string GetNarrativeAnchorIcon(string? moodCategory) => moodCategory?.ToLower() switch
    {
        "danger" => "‚ö†Ô∏è",
        "mystery" => "üîÆ",
        "safety" => "üè†",
        "urgency" => "‚è∞",
        _ => "üìç"
    };
}

@page "/join"
@page "/join/{InviteCode}"
@layout StackedLayout
@rendermode InteractiveServer

@using Riddle.Web.Models
@using Riddle.Web.Services
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

@inject ICharacterService CharacterService
@inject ICampaignService CampaignService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Join Campaign - Riddle</PageTitle>

<div class="flex justify-center px-4 py-6">
    <div class="w-full max-w-md">
        @if (isLoading)
        {
            <Card class="max-w-md p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                <div class="flex flex-col space-y-4 text-center py-4">
                    <Spinner Size="SpinnerSize.Xl" Color="SpinnerColor.Purple" />
                    <p class="text-gray-400">@loadingMessage</p>
                </div>
            </Card>
        }
        else if (errorMessage != null)
        {
            <Card class="max-w-md p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                <div class="flex flex-col space-y-4 text-center">
                    <span class="text-4xl">‚ùå</span>
                    <h2 class="text-xl font-bold text-white">Error</h2>
                    <p class="text-gray-400">@errorMessage</p>
                    <div class="flex flex-col space-y-3 pt-2">
                        <Button Color="ButtonColor.Primary" class="w-full" @onclick="ResetForm">
                            Try Another Code
                        </Button>
                        <Button Color="ButtonColor.Light" class="w-full" @onclick="GoHome">
                            Return Home
                        </Button>
                    </div>
                </div>
            </Card>
        }
        else if (campaign == null)
        {
            @* Enter Invite Code Form *@
            <Card class="max-w-md p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                <div class="flex flex-col space-y-6">
                    <div class="flex flex-col space-y-2 text-center">
                        <span class="text-4xl">üé≤</span>
                        <h1 class="text-2xl font-bold text-white">Join a Campaign</h1>
                        <p class="text-gray-400">Enter the invite code from your DM to join their campaign.</p>
                    </div>
                    
                    <div class="flex flex-col space-y-4">
                        <div>
                            <Label For="inviteCode" class="text-gray-300">Invite Code</Label>
                            <TextInput Id="inviteCode" 
                                       @bind-Value="enteredCode" 
                                       Placeholder="e.g., ABC123"
                                       class="text-center text-2xl tracking-widest uppercase" />
                        </div>
                        <Button Color="ButtonColor.Primary" 
                                class="w-full" 
                                Disabled="@string.IsNullOrWhiteSpace(enteredCode)"
                                @onclick="ValidateCode">
                            Join Campaign
                        </Button>
                    </div>
                </div>
            </Card>
        }
        else if (!isAuthenticated)
        {
            @* Login Required *@
            <Card class="max-w-md p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                <div class="flex flex-col space-y-6">
                    <div class="flex flex-col space-y-2 text-center">
                        <span class="text-4xl">üîê</span>
                        <h1 class="text-2xl font-bold text-white">Sign In Required</h1>
                        <p class="text-gray-400">You need to sign in to join:</p>
                        <p class="text-xl font-semibold text-purple-400">@campaign.Name</p>
                    </div>
                    
                    <Button Color="ButtonColor.Primary" class="w-full" @onclick="SignInAndReturn">
                    <span class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>
                        Sign in with Google
                        </span>
                    </Button>
                </div>
            </Card>
        }
        else if (selectedCharacter == null && availableCharacters.Any())
        {
            @* Character Selection *@
            <Card class="max-w-md p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                <div class="flex flex-col space-y-6">
                    <div class="flex flex-col space-y-2 text-center">
                        <Heading Tag="HeadingTag.H1" Size="TextSize.XXL">@campaign.Name</Heading>
                        <Paragraph class="!text-gray-400">@campaign.CampaignModule</Paragraph>
                    </div>
                    
                    <Heading Tag="HeadingTag.H2" Size="TextSize.LG">Choose Your Character</Heading>
                    <div class="space-y-2">
                    @foreach (var character in availableCharacters)
                    {
                        <button class="w-full p-3 bg-gray-700/50 hover:bg-gray-700 rounded-lg transition-colors text-left flex items-center gap-3 border border-gray-600 hover:border-purple-500 focus:ring-2 focus:ring-purple-500 focus:outline-none"
                                @onclick="() => ClaimCharacter(character)">
                            <Avatar Size="AvatarSize.Medium" 
                                    Rounded="true" 
                                    class="!bg-gradient-to-br !from-purple-500 !to-indigo-600 flex-shrink-0">
                                <span class="text-lg">@GetClassIcon(character.Class)</span>
                            </Avatar>
                            <div class="flex-1 min-w-0">
                                <Span Weight="FontWeight.SemiBold" CustomColor="text-white" class="block truncate">@character.Name</Span>
                                <Span Size="TextSize.SM" CustomColor="text-gray-400">@character.DisplayRaceClass ‚Ä¢ Level @character.Level</Span>
                            </div>
                        <ChevronRightIcon class="w-5 h-5 text-gray-500" />
                        </button>
                    }
                    </div>
                    
                    @if (alreadyClaimedCount > 0)
                    {
                        <Paragraph Size="TextSize.SM" class="!text-gray-500 text-center">
                            @alreadyClaimedCount character(s) already claimed by other players
                        </Paragraph>
                    }
                </div>
            </Card>
        }
        else if (!availableCharacters.Any() && playerCharacters.Any())
        {
            @* Already has character(s) - redirect to dashboard *@
            <Card class="max-w-md p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                <div class="flex flex-col space-y-4 text-center">
                    <span class="text-4xl">‚úÖ</span>
                    <h2 class="text-xl font-bold text-white">You're already in this campaign!</h2>
                    <p class="text-gray-400">Redirecting to your dashboard...</p>
                    <Spinner Size="SpinnerSize.Md" Color="SpinnerColor.Purple" />
                </div>
            </Card>
        }
        else if (!availableCharacters.Any())
        {
            @* No characters available *@
            <Card class="max-w-md p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                <div class="flex flex-col space-y-4 text-center">
                    <span class="text-4xl">üòî</span>
                    <h1 class="text-xl font-bold text-white">@campaign.Name</h1>
                    <p class="text-gray-400">All characters in this campaign have been claimed. Ask your DM to create more characters.</p>
                    <Button Color="ButtonColor.Light" class="w-full" @onclick="GoHome">
                        Return Home
                    </Button>
                </div>
            </Card>
        }
        else if (isClaiming)
        {
            @* Claiming in progress *@
            <Card class="max-w-md p-4 sm:p-6 md:p-8 bg-gray-800 border-gray-700">
                <div class="flex flex-col space-y-4 text-center py-4">
                    <Spinner Size="SpinnerSize.Xl" Color="SpinnerColor.Purple" />
                    <p class="text-gray-400">Claiming @selectedCharacter?.Name...</p>
                </div>
            </Card>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? InviteCode { get; set; }
    
    private CampaignInstance? campaign;
    private List<Character> availableCharacters = [];
    private List<Character> playerCharacters = [];
    private Character? selectedCharacter;
    
    private string? currentUserId;
    private string? currentUserName;
    private bool isAuthenticated = false;
    
    private bool isLoading = true;
    private bool isClaiming = false;
    private string loadingMessage = "Loading...";
    private string? errorMessage;
    private string enteredCode = "";
    private int alreadyClaimedCount = 0;
    
    protected override async Task OnInitializedAsync()
    {
        await CheckAuthenticationState();
        
        // If invite code provided in URL, validate it
        if (!string.IsNullOrWhiteSpace(InviteCode))
        {
            enteredCode = InviteCode;
            await ValidateCode();
        }
        else
        {
            isLoading = false;
        }
    }
    
    private async Task CheckAuthenticationState()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAuthenticated = user.Identity?.IsAuthenticated == true;
        
        if (isAuthenticated)
        {
            currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            currentUserName = user.Identity?.Name ?? user.FindFirst(ClaimTypes.Email)?.Value ?? "Unknown";
        }
    }
    
    private async Task ValidateCode()
    {
        if (string.IsNullOrWhiteSpace(enteredCode))
            return;
            
        isLoading = true;
        loadingMessage = "Validating invite code...";
        errorMessage = null;
        StateHasChanged();
        
        try
        {
            campaign = await CharacterService.ValidateInviteCodeAsync(enteredCode.Trim().ToUpper());
            
            if (campaign == null)
            {
                errorMessage = "Invalid invite code. Please check with your DM and try again.";
                return;
            }
            
            // Re-check auth in case it changed
            await CheckAuthenticationState();
            
            if (isAuthenticated)
            {
                await LoadCharacterData();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to validate code: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task LoadCharacterData()
    {
        if (campaign == null || currentUserId == null)
            return;
            
        // Check if player already has characters
        playerCharacters = await CharacterService.GetPlayerCharactersAsync(campaign.Id, currentUserId);
        
        if (playerCharacters.Any())
        {
            // Already in campaign - redirect to dashboard after brief delay
            await Task.Delay(1500);
            Navigation.NavigateTo($"/play/{campaign.Id}");
            return;
        }
        
        // Get available characters to claim
        availableCharacters = await CharacterService.GetAvailableCharactersAsync(campaign.Id);
        
        // Count already claimed characters
        alreadyClaimedCount = campaign.PartyState
            .Count(c => c.Type == "PC" && !string.IsNullOrEmpty(c.PlayerId));
    }
    
    private async Task ClaimCharacter(Character character)
    {
        if (campaign == null || currentUserId == null || currentUserName == null)
            return;
            
        selectedCharacter = character;
        isClaiming = true;
        StateHasChanged();
        
        try
        {
            var success = await CharacterService.ClaimCharacterAsync(
                campaign.Id, 
                character.Id, 
                currentUserId, 
                currentUserName);
            
            if (success)
            {
                // Redirect to player dashboard
                Navigation.NavigateTo($"/play/{campaign.Id}");
            }
            else
            {
                errorMessage = "Failed to claim character. It may have been claimed by another player.";
                selectedCharacter = null;
                // Refresh available characters
                await LoadCharacterData();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to claim character: {ex.Message}";
            selectedCharacter = null;
        }
        finally
        {
            isClaiming = false;
        }
    }
    
    private void SignInAndReturn()
    {
        // Build return URL with invite code
        var returnUrl = string.IsNullOrWhiteSpace(enteredCode) 
            ? "/join" 
            : $"/join/{enteredCode}";
        Navigation.NavigateTo($"/Account/Login?ReturnUrl={Uri.EscapeDataString(returnUrl)}");
    }
    
    private void ResetForm()
    {
        campaign = null;
        availableCharacters = [];
        selectedCharacter = null;
        errorMessage = null;
        enteredCode = "";
    }
    
    private void GoHome() => Navigation.NavigateTo("/");
    
    private string GetClassIcon(string? className) => className?.ToLower() switch
    {
        "fighter" => "‚öîÔ∏è",
        "wizard" => "üßô",
        "rogue" => "üó°Ô∏è",
        "cleric" => "‚úùÔ∏è",
        "paladin" => "üõ°Ô∏è",
        "ranger" => "üèπ",
        "barbarian" => "üí™",
        "bard" => "üéµ",
        "druid" => "üåø",
        "monk" => "üëä",
        "sorcerer" => "‚ú®",
        "warlock" => "üëÅÔ∏è",
        _ => "üë§"
    };
}
